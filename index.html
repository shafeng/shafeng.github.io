<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Shafeng`s blog</title>
  <meta name="author" content="shafeng">
  
  <meta name="description" content="c++">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Shafeng`s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Shafeng`s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Shafeng`s blog</a></h1>
  <h2><a href="/">road</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">目录</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-05-09T04:00:00.000Z"><a href="/2018/05/09/codis_3/">2018-05-09</a></time>
      
      
  
    <h1 class="title"><a href="/2018/05/09/codis_3/">codis(下)</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Codis_在程序中的使用">Codis 在程序中的使用</h2><p>前两篇文章记录了codis的安装和启动，以及服务器集群的架设，这一篇记录一下codis在工程中的使用情况。</p>
<h3 id="python测试程序">python测试程序</h3><p>用python连接codis服务器的测试程序，测试了一些简单的命令和简单排行榜。连接的ip地址是codis组件中proxy的地址，proxy接受的命令并不是全部是redis命令，具体情况参考官方文档</p>
<p>（<a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md）" target="_blank" rel="external">https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md）</a></p>
<hr>
<pre><code>import redis   <span class="preprocessor"># 导入redis模块，通过python操作redis 也可以直接在redis主机的服务端操作缓存数据库</span>

r = redis.Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>, decode_responses=<span class="literal">True</span>)   <span class="preprocessor"># host是redis主机，需要redis服务端和客户端都启动 redis默认端口是6379</span>

<span class="preprocessor">#r.set(<span class="string">'name2'</span>, <span class="string">'warship3'</span>)  # key是<span class="string">"foo"</span> value是<span class="string">"bar"</span> 将键值对存入redis缓存</span>
<span class="preprocessor"># print(r[<span class="string">'name2'</span>])</span>
<span class="preprocessor"># print(r.get(<span class="string">'name2'</span>))  # 取出键name对应的值</span>
<span class="preprocessor"># print(type(r.get(<span class="string">'name2'</span>)))</span>

<span class="preprocessor">#r.hmset(<span class="string">"myhash"</span>,{<span class="string">"field1"</span>:<span class="string">"Hello"</span>,<span class="string">"field2"</span>:<span class="string">"World"</span>}) </span>
<span class="preprocessor"># r.zadd(<span class="string">"499-rank-100"</span>,5,111)</span>
<span class="preprocessor"># r.zadd(<span class="string">"499-rank-100"</span>,2,112)</span>
<span class="preprocessor"># r.zadd(<span class="string">"499-rank-100"</span>,30,113)</span>
<span class="preprocessor"># r.zadd(<span class="string">"499-rank-100"</span>,10,114)</span>

<span class="preprocessor">#ZRANGE myzset 0 -1 WITHSCORES</span>

<span class="preprocessor"># print(type(r.zrange(<span class="string">"499-rank-100"</span>,0,3,withscores=True)))</span>
<span class="preprocessor"># print(r.zrange(<span class="string">"499-rank-100"</span>,0,3,withscores=True))</span>
<span class="preprocessor"># print(r.zrevrange(<span class="string">"499-rank-100"</span>,0,3,withscores=True))</span>
<span class="preprocessor"># print(r.zrevrank(<span class="string">"499-rank-100"</span>,10))</span>

print(r.zrevrange(<span class="string">"1014-rank-4"</span>,<span class="number">0</span>,<span class="number">100</span>,withscores=<span class="literal">True</span>))
print(r.zrevrank(<span class="string">"1014-rank-4"</span>,<span class="number">10</span>))
</code></pre><hr>
<h3 id="项目中的实际使用">项目中的实际使用</h3><p>首先我们的项目在没有引入codis之前，所有的数据全部存储在mysql中，玩家摘要和排行榜这些请求量比较大的数据都是在程序初始化的时候全部加载到内存中的，引入codis后，需要把这些数据全部在codis中做一份拷贝（用python做这类工作非常效率，因为我们的mysql数据中每一张数据表都有一个modify_time字段，标识了该条数据的上一次修改时间，所以只要根据这个字段就可以在不停服的情况下做前期的数据拷贝，停服后只需要同步最后一点时间内修改的数据就好了），工程中使用这些数据的时候需要把mysql和codis中的数据同步更新，由于mysql的数据更可信，所以在mysql和redis的数据出现不匹配的情况下，选择mysql中的数据，而大量对摘要和排行榜数据的请求全部交给codis处理，这样不仅分离了项目主程序和摘要排行榜数据，也加快了读取这些数据的速度。</p>
<p>上线后codis的表现比较好，没有出现过什么问题，如果各个group的内存使用不太平均，还可以使用codis网页工具提供的功能对slot进行动态转移，把内存量使用大的group中的slot分配到其它group中。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-05-08T04:00:00.000Z"><a href="/2018/05/08/codis_2/">2018-05-08</a></time>
      
      
  
    <h1 class="title"><a href="/2018/05/08/codis_2/">codis(中)</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Codis_Dashboard_的配置和使用">Codis Dashboard 的配置和使用</h2><p>前一篇文章记录了codis的安装和启动，这一篇记录一下codis的使用。 codis的环境布置好之后需要用codis的网页来进行一系列配置，包括redis组的配置和代理地址的添加等等</p>
<p>管理页面的主页，显示了当前使用的内存量，连接数，redis中存储的key的数量和每秒请求数</p>
<hr>
<p><img src="/2018/05/08/codis_2/main.png" alt="主页"></p>
<hr>
<p>在 Proxy 栏可看到我们已经启动的 Proxy， 但是 Group 栏为空，因为我们启动的 codis-server 并未加入到集群 添加 NEW GROUP，NEW GROUP 行输入 1，再点击 NEW GROUP 即可 添加 Codis Server</p>
<hr>
<p><img src="/2018/05/08/codis_2/proxy.png" alt="代理"></p>
<hr>
<p>添加实例（即添加后端的redis服务器）<br>Add Server 行输入我们刚刚启动的 codis-server 地址，添加到我们刚新建的 Group，然后再点击 Add Server 按钮即可</p>
<hr>
<p><img src="/2018/05/08/codis_2/group.png" alt="redis组"></p>
<hr>
<p>对slot初始化要分组，之后可以动态调整slot的归属</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-05-07T04:00:00.000Z"><a href="/2018/05/07/codis_1/">2018-05-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/05/07/codis_1/">codis(上)</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Redis集群，Codis的安装和使用">Redis集群，Codis的安装和使用</h2><p>项目上经过了多次合服和长达两年多的运营，单服玩家已经超过了600W,项目最原始的架构是将所有玩家的摘要数据在服务器启动时从数据库中读取，如果只有几万人或者及几十万人，启动速度基本上就是一两分钟的样子，没有什么压力，但是600W玩家的所有摘要数据全部加载需要的时间可能超过几十分钟，为此项目使用了Redis，将玩家摘要数据和排行榜数据全部都转移到了Redis中，我使用了Codis，基于go开发的redis集群，可以无限扩展Redis的内存大小。记录一下部署和使用Codis的全过程。</p>
<p><img src="/2018/05/07/codis_1/codis.png" alt="Codis"></p>
<h3 id="安装环境">安装环境</h3><p>codis-proxy相当于redis，即连接codis-proxy和连接redis是没有任何区别的，codis-proxy无状态，不负责记录是否在哪保存，数据在zookeeper记录，即codis proxy向zookeeper查询key的记录位置，proxy 将请求转发到一个组进行处理，一个组里面有一个master和一个或者多个slave组成，默认有1024个槽位，其把不同的槽位的内容放在不通的group。codis是基于go语言编写的，因此要安装go语言环境。每台服务器安装java环境和zookeeper，zookeeper集群最少需要3台服务器。</p>
<h4 id="安装_zookeeper">安装 zookeeper</h4><pre><code>wget http:<span class="comment">//219.238.7.67/files/205200000AF1D7B9/mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz</span>
tar -xzf zookeeper-<span class="number">3.4</span>.<span class="number">11</span><span class="class">.tar</span><span class="class">.gz</span> -C /data/service
</code></pre><h4 id="安装_java">安装 java</h4><pre><code>tar zxf jdk-<span class="number">8u</span>131-linux-x64.gz
mv jdk1<span class="number">.8</span><span class="number">.0</span>_131 /usr/local/
</code></pre><h4 id="安装_go_编译环境">安装 go 编译环境</h4><pre><code># cd /usr/local/src
[root@node1 src]# yum <span class="operator"><span class="keyword">install</span> -y gcc glibc gcc-<span class="keyword">c</span>++ make git
[root@node1 src]# wget https://<span class="keyword">storage</span>.googleapis.com/golang/go1<span class="number">.7</span><span class="number">.3</span>.linux-amd64.tar.gz
[root@node1 src]# tar zxf go1<span class="number">.7</span><span class="number">.3</span>.linux-amd64.tar.gz
[root@node1 src]# mv <span class="keyword">go</span> /usr/<span class="keyword">local</span>/
[root@node1 src]# mkdir /usr/<span class="keyword">local</span>/<span class="keyword">go</span>/<span class="keyword">work</span>
[root@node1 src]# vim /root/.bash_profile

<span class="keyword">export</span> <span class="keyword">PATH</span>=$<span class="keyword">PATH</span>:/usr/<span class="keyword">local</span>/<span class="keyword">go</span>/<span class="keyword">bin</span>
<span class="keyword">export</span> GOROOT=/usr/<span class="keyword">local</span>/<span class="keyword">go</span>
<span class="keyword">export</span> GOPATH=/usr/<span class="keyword">local</span>/<span class="keyword">go</span>/<span class="keyword">work</span>
<span class="keyword">path</span>=$<span class="keyword">PATH</span>:$HOME/<span class="keyword">bin</span>:$GOROOT/<span class="keyword">bin</span>:$GOPATH/<span class="keyword">bin</span>
[root@node1 src]# <span class="keyword">source</span> /root/.bash_profile

[root@node1 src]# echo $GOPATH
/usr/<span class="keyword">local</span>/<span class="keyword">go</span>/<span class="keyword">work</span>
[root@node1 ~]# <span class="keyword">go</span> <span class="keyword">version</span>
<span class="keyword">go</span> <span class="keyword">version</span> go1<span class="number">.7</span><span class="number">.3</span> linux/amd64</span>
</code></pre><h4 id="zookeeper配置文件">zookeeper配置文件</h4><pre><code><span class="preprocessor"># 中使用的基本时间单位, 毫秒值.</span>
tickTime=<span class="number">2000</span>
<span class="preprocessor"># follower和leader之间的最长心跳时间 initLimit * tickTime 毫秒超时</span>
initLimit=<span class="number">10</span>
<span class="preprocessor"># </span>
<span class="preprocessor"># follower和leader之间 同步数据的最大时间 syncLimit * tickTime 毫秒超时</span>
syncLimit=<span class="number">5</span>
<span class="preprocessor"># 数据目录. 可以是任意目录.</span>
dataDir=/data/service/zookeeper-data/data
<span class="preprocessor"># log目录</span>
dataLogDir=/data/service/zookeeper-data/logs
<span class="preprocessor"># 防止启动失败一个配置，不知道干啥的</span>
quorumListenOnAllIPs=<span class="literal">true</span>
<span class="preprocessor"># 监听client连接的端口号.</span>
clientPort=<span class="number">19021</span>
<span class="preprocessor"># 客户端连接的最大数量。</span>
<span class="preprocessor">#maxClientCnxns=<span class="number">60</span></span>
<span class="preprocessor"># 维护相关的</span>
<span class="preprocessor">#autopurge.snapRetainCount=<span class="number">3</span></span>
<span class="preprocessor">#autopurge.purgeInterval=<span class="number">1</span></span>

server<span class="number">.1</span> = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">19022</span>:<span class="number">19029</span>
server<span class="number">.2</span> = <span class="number">172.31</span><span class="number">.0</span><span class="number">.17</span>:<span class="number">19022</span>:<span class="number">19029</span>
server<span class="number">.3</span> = <span class="number">172.31</span><span class="number">.0</span><span class="number">.79</span>:<span class="number">19022</span>:<span class="number">19029</span>
</code></pre><p>详细解释：<br>            tickTime：这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。<br>            dataDir：顾名思义就是 Zookeeper 保存数据的目录，默认情况下，Zookeeper 将写数据的日志文件也保存在这个目录里。<br>            clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。<br>            initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 10<em>6000=60 秒<br>            syncLimit：这个配置项标识 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 5</em>6000=30 秒<br>            server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</p>
<p>启动zookeeper</p>
<pre><code><span class="regexp">/data/</span>service<span class="regexp">/zookeeper-3.4.11/</span>bin<span class="regexp">/zkServer.sh  /</span>data<span class="regexp">/service/</span>zookeeper-<span class="number">3.4</span>.<span class="number">11</span><span class="regexp">/conf/</span>zoo.cfg
</code></pre><h3 id="安装部署codis">安装部署codis</h3><h4 id="下载编译codis3-2版本">下载编译codis3.2版本</h4><p>我直接使用了编译好的一个版本</p>
<h4 id="codis配置文件">codis配置文件</h4><hr>
<font color="#FF6347">/codis/config/dashboard.toml</font>

<pre><code><span class="comment">##################################################</span>
<span class="comment">#                                                #</span>
<span class="comment">#                  Codis-Dashboard               #</span>
<span class="comment">#                                                #</span>
<span class="comment">##################################################</span>

<span class="comment"># Set Coordinator, only accept "zookeeper" &amp; "etcd" &amp; "filesystem".</span>
<span class="comment"># for zookeeper/etcd, coorinator_auth accept "user:password" </span>
<span class="comment"># Quick Start</span>
<span class="comment">#coordinator_name = "filesystem"</span>
<span class="comment">#coordinator_addr = "/tmp/codis"</span>
<span class="setting">coordinator_name = <span class="value"><span class="string">"zookeeper"</span></span></span>
<span class="setting">coordinator_addr = <span class="value"><span class="string">"172.31.0.84:19021"</span></span></span>
<span class="comment">#coordinator_auth = ""</span>

<span class="comment"># Set Codis Product Name/Auth.</span>
<span class="setting">product_name = <span class="value"><span class="string">"codis-warship"</span></span></span>
<span class="setting">product_auth = <span class="value"><span class="string">""</span></span></span>

<span class="comment"># Set bind address for admin(rpc), tcp only.</span>
<span class="setting">admin_addr = <span class="value"><span class="string">"0.0.0.0:18080"</span></span></span>

<span class="comment"># Set arguments for data migration (only accept 'sync' &amp; 'semi-async').</span>
<span class="setting">migration_method = <span class="value"><span class="string">"semi-async"</span></span></span>
<span class="setting">migration_parallel_slots = <span class="value"><span class="number">100</span></span></span>
<span class="setting">migration_async_maxbulks = <span class="value"><span class="number">200</span></span></span>
<span class="setting">migration_async_maxbytes = <span class="value"><span class="string">"32mb"</span></span></span>
<span class="setting">migration_async_numkeys = <span class="value"><span class="number">500</span></span></span>
<span class="setting">migration_timeout = <span class="value"><span class="string">"30s"</span></span></span>

<span class="comment"># Set configs for redis sentinel.</span>
<span class="setting">sentinel_client_timeout = <span class="value"><span class="string">"10s"</span></span></span>
<span class="setting">sentinel_quorum = <span class="value"><span class="number">2</span></span></span>
<span class="setting">sentinel_parallel_syncs = <span class="value"><span class="number">1</span></span></span>
<span class="setting">sentinel_down_after = <span class="value"><span class="string">"30s"</span></span></span>
<span class="setting">sentinel_failover_timeout = <span class="value"><span class="string">"5m"</span></span></span>
<span class="setting">sentinel_notification_script = <span class="value"><span class="string">""</span></span></span>
<span class="setting">sentinel_client_reconfig_script = <span class="value"><span class="string">""</span></span></span>
</code></pre><p>启动dashboard：</p>
<pre><code>[root<span class="variable">@node1</span> codis]# nohup ./bin/codis-dashboard --ncpu=<span class="number">1</span> --config=config/dashboard.toml --<span class="keyword">log</span>=dashboard.<span class="keyword">log</span> --<span class="keyword">log</span>-level=WARN &gt;&gt; /var/<span class="keyword">log</span>/codis_dashboard.<span class="keyword">log</span> &amp;
</code></pre><hr>
<font color="#FF6347">/codis/config/proxy.toml</font>


<pre><code>##################################################
#                                                #
#                  Codis-Proxy                   #
#                                                #
##################################################

# <span class="operator"><span class="keyword">Set</span> Codis Product <span class="keyword">Name</span>/Auth.
product_name = <span class="string">"codis-warship"</span>
product_auth = <span class="string">""</span>

# <span class="keyword">Set</span> auth <span class="keyword">for</span> <span class="keyword">client</span> <span class="keyword">session</span>
#   <span class="number">1.</span> product_auth <span class="keyword">is</span> used <span class="keyword">for</span> auth <span class="keyword">validation</span> among codis-dashboard,
#      codis-proxy <span class="keyword">and</span> codis-<span class="keyword">server</span>.
#   <span class="number">2.</span> session_auth <span class="keyword">is</span> different <span class="keyword">from</span> product_auth, it requires clients
#      <span class="keyword">to</span> issue AUTH &lt;<span class="keyword">PASSWORD</span>&gt; <span class="keyword">before</span> processing <span class="keyword">any</span> other commands.
session_auth = <span class="string">""</span>

# <span class="keyword">Set</span> bind address <span class="keyword">for</span> <span class="keyword">admin</span>(rpc), tcp <span class="keyword">only</span>.
admin_addr = <span class="string">"0.0.0.0:11080"</span>

# <span class="keyword">Set</span> bind address <span class="keyword">for</span> proxy, proto_type can be <span class="string">"tcp"</span>, <span class="string">"tcp4"</span>, <span class="string">"tcp6"</span>, <span class="string">"unix"</span> <span class="keyword">or</span> <span class="string">"unixpacket"</span>.
proto_type = <span class="string">"tcp4"</span>
proxy_addr = <span class="string">"0.0.0.0:19000"</span>

# <span class="keyword">Set</span> jodis address &amp; <span class="keyword">session</span> <span class="keyword">timeout</span>
#   <span class="number">1.</span> jodis_name <span class="keyword">is</span> <span class="keyword">short</span> <span class="keyword">for</span> jodis_coordinator_name, <span class="keyword">only</span> <span class="keyword">accept</span> <span class="string">"zookeeper"</span> &amp; <span class="string">"etcd"</span>.
#   <span class="number">2.</span> jodis_addr <span class="keyword">is</span> <span class="keyword">short</span> <span class="keyword">for</span> jodis_coordinator_addr
#   <span class="number">3.</span> jodis_auth <span class="keyword">is</span> <span class="keyword">short</span> <span class="keyword">for</span> jodis_coordinator_auth, <span class="keyword">for</span> zookeeper/etcd, <span class="string">"user:password"</span> <span class="keyword">is</span> accepted.
#   <span class="number">4.</span> proxy will be registered <span class="keyword">as</span> node:
#        <span class="keyword">if</span> jodis_compatible = <span class="literal">true</span> (<span class="keyword">not</span> suggested):
#          /zk/codis/db_{PRODUCT_NAME}/proxy-{HASHID} (compatible <span class="keyword">with</span> Codis2<span class="number">.0</span>)
#        <span class="keyword">or</span> <span class="keyword">else</span>
#          /jodis/{PRODUCT_NAME}/proxy-{HASHID}
jodis_name = <span class="string">"zookeeper"</span>
jodis_addr = <span class="string">"172.31.0.84:19021,172.31.0.17:19021,172.31.0.79:19021"</span>
jodis_auth = <span class="string">""</span>
jodis_timeout = <span class="string">"20s"</span>
jodis_compatible = <span class="literal">true</span>

# <span class="keyword">Set</span> datacenter <span class="keyword">of</span> proxy.
proxy_datacenter = <span class="string">""</span>

# <span class="keyword">Set</span> <span class="keyword">max</span> <span class="built_in">number</span> <span class="keyword">of</span> alive sessions.
proxy_max_clients = <span class="number">1000</span>

# <span class="keyword">Set</span> <span class="keyword">max</span> offheap <span class="keyword">memory</span> <span class="keyword">size</span>. (<span class="number">0</span> <span class="keyword">to</span> <span class="keyword">disable</span>)
proxy_max_offheap_size = <span class="string">"1024mb"</span>

# <span class="keyword">Set</span> <span class="keyword">heap</span> placeholder <span class="keyword">to</span> reduce GC frequency.
proxy_heap_placeholder = <span class="string">"256mb"</span>

# Proxy will ping backend redis (<span class="keyword">and</span> <span class="keyword">clear</span> <span class="string">'MASTERDOWN'</span> state) <span class="keyword">in</span> a predefined <span class="built_in">interval</span>. (<span class="number">0</span> <span class="keyword">to</span> <span class="keyword">disable</span>)
backend_ping_period = <span class="string">"5s"</span>

# <span class="keyword">Set</span> backend recv buffer <span class="keyword">size</span> &amp; <span class="keyword">timeout</span>.
backend_recv_bufsize = <span class="string">"128kb"</span>
backend_recv_timeout = <span class="string">"30s"</span>

# <span class="keyword">Set</span> backend send buffer &amp; <span class="keyword">timeout</span>.
backend_send_bufsize = <span class="string">"128kb"</span>
backend_send_timeout = <span class="string">"30s"</span>

# <span class="keyword">Set</span> backend pipeline buffer <span class="keyword">size</span>.
backend_max_pipeline = <span class="number">20480</span>

# <span class="keyword">Set</span> backend <span class="keyword">never</span> <span class="keyword">read</span> replica <span class="keyword">groups</span>, <span class="keyword">default</span> <span class="keyword">is</span> <span class="literal">false</span>
backend_primary_only = <span class="literal">false</span>

# <span class="keyword">Set</span> backend <span class="keyword">parallel</span> connections per <span class="keyword">server</span>
backend_primary_parallel = <span class="number">1</span>
backend_replica_parallel = <span class="number">1</span>

# <span class="keyword">Set</span> backend tcp keepalive <span class="keyword">period</span>. (<span class="number">0</span> <span class="keyword">to</span> <span class="keyword">disable</span>)
backend_keepalive_period = <span class="string">"75s"</span>

# <span class="keyword">Set</span> <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">databases</span> <span class="keyword">of</span> backend.
backend_number_databases = <span class="number">16</span>

# <span class="keyword">If</span> there <span class="keyword">is</span> <span class="keyword">no</span> request <span class="keyword">from</span> <span class="keyword">client</span> <span class="keyword">for</span> a <span class="keyword">long</span> <span class="keyword">time</span>, the <span class="keyword">connection</span> will be closed. (<span class="number">0</span> <span class="keyword">to</span> <span class="keyword">disable</span>)
# <span class="keyword">Set</span> <span class="keyword">session</span> recv buffer <span class="keyword">size</span> &amp; <span class="keyword">timeout</span>.
session_recv_bufsize = <span class="string">"128kb"</span>
session_recv_timeout = <span class="string">"30m"</span>

# <span class="keyword">Set</span> <span class="keyword">session</span> send buffer <span class="keyword">size</span> &amp; <span class="keyword">timeout</span>.
session_send_bufsize = <span class="string">"64kb"</span>
session_send_timeout = <span class="string">"30s"</span>

# Make sure this <span class="keyword">is</span> higher <span class="keyword">than</span> the <span class="keyword">max</span> <span class="built_in">number</span> <span class="keyword">of</span> requests <span class="keyword">for</span> <span class="keyword">each</span> pipeline request, <span class="keyword">or</span> your <span class="keyword">client</span> may be blocked.
# <span class="keyword">Set</span> <span class="keyword">session</span> pipeline buffer <span class="keyword">size</span>.
session_max_pipeline = <span class="number">10000</span>

# <span class="keyword">Set</span> <span class="keyword">session</span> tcp keepalive <span class="keyword">period</span>. (<span class="number">0</span> <span class="keyword">to</span> <span class="keyword">disable</span>)
session_keepalive_period = <span class="string">"75s"</span>

# <span class="keyword">Set</span> <span class="keyword">session</span> <span class="keyword">to</span> be sensitive <span class="keyword">to</span> failures. <span class="keyword">Default</span> <span class="keyword">is</span> <span class="literal">false</span>, instead <span class="keyword">of</span> closing socket, proxy will send an <span class="keyword">error</span> response <span class="keyword">to</span> <span class="keyword">client</span>.
session_break_on_failure = <span class="literal">false</span>

# <span class="keyword">Set</span> metrics <span class="keyword">server</span> (such <span class="keyword">as</span> <span class="keyword">http</span>://localhost:<span class="number">28000</span>), proxy will report <span class="keyword">json</span> formatted metrics <span class="keyword">to</span> specified <span class="keyword">server</span> <span class="keyword">in</span> a predefined <span class="keyword">period</span>.
metrics_report_server = <span class="string">""</span>
metrics_report_period = <span class="string">"1s"</span>

# <span class="keyword">Set</span> influxdb <span class="keyword">server</span> (such <span class="keyword">as</span> <span class="keyword">http</span>://localhost:<span class="number">8086</span>), proxy will report metrics <span class="keyword">to</span> influxdb.
metrics_report_influxdb_server = <span class="string">""</span>
metrics_report_influxdb_period = <span class="string">"1s"</span>
metrics_report_influxdb_username = <span class="string">""</span>
metrics_report_influxdb_password = <span class="string">""</span>
metrics_report_influxdb_database = <span class="string">""</span>

# <span class="keyword">Set</span> statsd <span class="keyword">server</span> (such <span class="keyword">as</span> localhost:<span class="number">8125</span>), proxy will report metrics <span class="keyword">to</span> statsd.
metrics_report_statsd_server = <span class="string">""</span>
metrics_report_statsd_period = <span class="string">"1s"</span>
metrics_report_statsd_prefix = <span class="string">""</span></span>
</code></pre><p>启动代理</p>
<pre><code>[root<span class="variable">@node1</span> codis]# nohup ./bin/codis-proxy --ncpu=<span class="number">1</span> --config=config/proxy.toml --<span class="keyword">log</span>=proxy.<span class="keyword">log</span> --<span class="keyword">log</span>-level=WARN &gt;&gt; /var/<span class="keyword">log</span>/codis_proxy.<span class="keyword">log</span> &amp;
</code></pre><hr>
<p><font color="#FF6347">/codis/config/redis-6380.conf</font>   redis的配置主要是改这几个</p>
<pre><code>bind <span class="number">172.31</span><span class="number">.0</span><span class="number">.84</span>
port <span class="number">6380</span>
pidfile <span class="string">"/tmp/redis_6380.pid"</span>
maxmemory <span class="number">12</span>G
dir <span class="string">"/data/service/codis"</span>
logfile <span class="string">"/tmp/redis_6380.log"</span>
</code></pre><p>通过codis-server指定redis.conf文件启动redis服务，不能通过redis命令启动redis服务，通过redis启动的redis 服务加到codis集群无法正常使用：</p>
<pre><code>[root<span class="constant">@redis1</span> codis]<span class="preprocessor"># ./bin/codis-server ../config/redis_6380.conf </span>
</code></pre><h3 id="使用codis的网页服务器配置codis服务器">使用codis的网页服务器配置codis服务器</h3><p>启动codis-fe</p>
<pre><code>nohup ./bin/codis-fe --ncpu=<span class="number">1</span> --<span class="built_in">log</span>=fe.<span class="built_in">log</span> --<span class="built_in">log</span>-level=WARN --zookeeper=<span class="number">172.31</span><span class="number">.0</span><span class="number">.84</span>:<span class="number">19021</span> --listen=<span class="number">172.31</span><span class="number">.0</span><span class="number">.84</span>:<span class="number">8060</span>
</code></pre><hr>
<p>以上配置是我在实际使用中的配置，官方的教程在这里：</p>
<pre><code><span class="string">https:</span><span class="comment">//github.com/CodisLabs/codis/blob/release3.2/doc/tutorial_zh.md</span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-01-25T04:00:00.000Z"><a href="/2018/01/25/gperftools/">2018-01-25</a></time>
      
      
  
    <h1 class="title"><a href="/2018/01/25/gperftools/">记一次使用gperftools分析线上程序</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="gperftools的实战使用经验">gperftools的实战使用经验</h1><p>项目自上线之后一直有玩家反应战斗的时候会有不太流畅的情况出现，尤其是人数多，生成战斗对象多的情况下，经过对程序的监控并没有发现什么异常，主机资源的使用上也没发现什么问题，cpu和内存的使用率都不高，网络进出流量也并没有达到峰值，cpu使用率和网络的抖动从监控上看也看不出什么问题，这个问题困扰了我很久，一直苦于无法解决，不过通过我对cpu使用率的观察，感觉cpu虽然没有长时间的抖动，但是偶尔会有一个比较大的抖动出现，时间很短，但是抖动的范围还是比较大的，最后我找到了google的性能分析工具gperftools，因为我们的程序可以分布负载，可以用多个进程将一部分大的功能负载，这些进程本身是没有什么区别的，可以随意动态增加减少，所以我拿出了一个线上程序做了这次实验，把gperftools的相关库链接到了我的程序上并添加相关代码编译后放到线上环境中去运行，运行24小时候后停止程序并分析输出报告，然后解决报告中可见的问题，解决之后再次将新的程序放到线上运行24小时，如此循环一直到输出报告中看不到明显异常为止。   在这次实验中，确实发现了几个消耗cpu特别严重的函数调用，这些函数使用频繁，而且又非常耗费cpu，如果实例对象特别多的时候确实有可能造成cpu的抖动从而影响玩家正常体验。  把这些问题都完善之后确实收到了效果，反应战斗不流畅的玩家数量大幅减少，可以说这次优化还是比较成功的，记录一下gperftools的使用方法,gperftools可以分析cpu和内存的性能，下面分别写了例子和用法。</p>
<p>gperftools是google出品的一个性能分析工具，相关介绍可见:<br><a href="https://github.com/gperftools/gperftools/wiki" target="_blank" rel="external">https://github.com/gperftools/gperftools/wiki</a><br>gperftools性能分析通过抽样方法完成，默认是1秒100个样本，即一个样本是10毫秒，因此程序运行时间要长一些。</p>
<h2 id="编译安装gperftools">编译安装gperftools</h2><p>从<a href="https://github.com/gperftools/gperftools/releases" target="_blank" rel="external">https://github.com/gperftools/gperftools/releases</a>   下载最新版本的gperftools源码包<br>解压到/usr/local/src目录，编译安装</p>
<h2 id="cpu性能分析">cpu性能分析</h2><pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;google/profiler.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;
<span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i) 
    {
        ++i;
        <span class="keyword">char</span> *p = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span>);
        <span class="built_in">free</span>(p);
    }  
}
<span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200000</span>; ++i) 
    {
        <span class="keyword">char</span> *p = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span>);
        <span class="built_in">free</span>(p);
    }  
}
<span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i) 
    {
        func1();
        func2();
    }  
}

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    ProfilerStart(<span class="string">"test.prof"</span>);<span class="comment">//开启性能分析并指定所生成的profile文件名</span>
    func3();
    ProfilerStop();<span class="comment">//停止性能分析并输出结果(如果这行代码不运行，将无法输出任何数据，只有一个空文件)</span>
    <span class="keyword">return</span> <span class="number">0</span>; 
}

编译上面的程序文件test.cpp，连接tcmalloc和profiler
g++ -I/work/trunk/ThirdParty/include/  -L/work/trunk/haizhan/Linux64_6<span class="number">.3</span><span class="number">.0</span>_Debug/commonlib/ -Wl,-rpath,/work/trunk/haizhan/Linux64_6<span class="number">.3</span><span class="number">.0</span>_Debug/commonlib/   -ltcmalloc -lprofiler   test.cpp -o test
运行程序，等待程序退出后输出分析
./text
将程序输出的分析结果解析成pdf，需要安装graphviz
yum install graphviz
/work/trunk/haizhan/Linux64_6<span class="number">.3</span><span class="number">.0</span>_Debug/share_bin/pprof -pdf  test test.prof  &gt; CpuProfiler.pdf
</code></pre><p>可以看到cpu在各个函数中的消耗，上面的百分比是本函数的消耗，下面的百分比是本函数所在堆栈所有函数的消耗，可以很清楚的分析出严重消耗cpu的问题函数。</p>
<p><img src="/2018/01/25/gperftools/0001.jpg" alt="CpuProfiler.pdf"></p>
<p>我们线上项目的分析报告已经被我删掉了。。。很遗憾没法记录当时的程序运行情况和每天优化后重新运行的分析情况。</p>
<hr>
<h2 id="内存性能分析">内存性能分析</h2><pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;gperftools/heap-profiler.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;
<span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i) 
    {
        ++i;
        <span class="keyword">char</span> *p = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span>);
        <span class="built_in">free</span>(p);
    }  
}
<span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200000</span>; ++i) 
    {
        <span class="keyword">char</span> *p = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span>);
        <span class="built_in">free</span>(p);
    }  
}
<span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">()</span> 
</span>{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i) 
    {
        func1();
        func2();
    }  
}

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    HeapProfilerStart(<span class="string">"test.prof"</span>);<span class="comment">//开启内存分析并指定所生成的profile文件名</span>
    func3();
    HeapProfilerStop();<span class="comment">//停止内存分析并输出结果(如果这行代码不运行，将无法输出任何数据，只有一个空文件)</span>
    <span class="keyword">return</span> <span class="number">0</span>; 
}


编译，运行并输出pdf(同CPU性能分析)，不同之处在于内存分析每产生<span class="number">1</span>G的内存使用就会生成一个文件，生成pdf的时候需要包含所有生成的文件
/work/trunk/haizhan/Linux64_6<span class="number">.3</span><span class="number">.0</span>_Debug/share_bin/pprof -pdf  test test.prof.*.heap  &gt; out.pdf
</code></pre><p><img src="/2018/01/25/gperftools/0002.jpg" alt="MemoryProfiler.pdf"></p>
<p>官方给出的建议是虽然gperftools对程序性能的影响不是非常大，也尽量不要在线上环境使用gperftools，但是经过我的使用发现gperftools大概会降低程序30%左右的效率，如果你的程序本身占用cpu并不高，而有些问题又必须在线上真实环境下才可能表现的出来，完全可以放到线上尝试一下。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-12-01T04:00:00.000Z"><a href="/2017/12/01/TCMalloc/">2017-12-01</a></time>
      
      
  
    <h1 class="title"><a href="/2017/12/01/TCMalloc/">内存池tcmalloc的使用</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="tcmalloc">tcmalloc</h1><p>由于项目引入了协程，之前使用的内存泄漏和越界检测工具asan就不能用了，asan官方说对协程的支持不够。 所以只能换一个工具，tcmalloc是一个不错的替代品，同时tcmalloc还提供了内存管理的功能</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-16T04:00:00.000Z"><a href="/2017/11/16/C++协程_2/">2017-11-16</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/16/C++协程_2/">C++中的协程(下)</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="ucontext协程的封装">ucontext协程的封装</h1><p>前面介绍了unix自带的ucontext相关函数，现在记录一下我们实际项目中的使用。</p>
<p>我们的项目中，每个玩家在登陆时创建玩家对象<code>CHZUser</code>，同时通过<code>SVR_BASE::co_create</code>函数创建一个协程上下文对象（后面简称协程对象），协程对象的执行函数是该玩家的消息循环函数<code>CHZUser::message_loop</code>,</p>
<h2 id="总结">总结</h2><p>以上就是ucontext的全部内容，非常简洁。我们项目中使用的就是ucontext，后面再记录一下项目中的实际使用情况。</p>
<pre><code><span class="class"><span class="keyword">enum</span> <span class="title">CoroutineStatus_t</span></span>
{
    emCoroutine_closed    =<span class="number">0</span>,    <span class="regexp">//</span><span class="regexp">/&lt; 关闭的
    emCoroutine_WaitRun,    /</span><span class="regexp">//</span>&lt; 等待执行
    emCoroutine_Runing,        <span class="regexp">//</span><span class="regexp">/&lt; 正在执行
    emCoroutine_Message,    /</span><span class="regexp">//</span>&lt; 等着消息
    emCoroutine_IOComplete    /<span class="regexp">//</span>&lt; 等待<span class="constant">IO</span>完成
};
</code></pre><p>协程的五个状态</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-15T04:00:00.000Z"><a href="/2017/11/15/C++协程_1/">2017-11-15</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/15/C++协程_1/">C++中的协程(上)</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="c++中协程的使用">c++中协程的使用</h1><p>我们的项目在逻辑中的异步操作并不太多，而且使用异步本身是一件很麻烦的事情，mysql也没有封装异步的方法，但是后期一些项目上的功能需要使用异步sql查询数据库，为了适应项目的发展和需求，引入了协程。</p>
<p>从原理上看，协程保存了程序执行的当前位置，后续可以切换回来，即便是在一个完整函数的中间，也可以切走再切回来，像是一个用户态的线程，但是和线程不同的是，协程之间的切换需要我们自己实现。协程的好处是可以用符合思维习惯的同步写法，写出具有异步功能的高效代码，而不用像传统异步开发那样，设置各种回调函数把代码割离，弄的支离破碎很难理解。不过协程的切换虽然不会切到内核态，完全由用户来控制切换，但是协程的切换造成的开销，还是会比异步回调的方法开销大一些，但是总体来说，同步的写法实现异步这种好处还是盖过了切换带来的效率损耗。</p>
<p>因为c++并没有标准的协程库，所以各种实现协程的方法很多，当前比较知名的是仿go语言实现的c++库libgo，腾讯的libco，boost的coroutine，context组件，unix系统自带的ucontext等等。  这些库我只看过libco和ucontext，腾讯的libco封装的太高级，其实用到自己项目中是不太灵活的，但是libco用汇编重写了切换协程的代码，在这方面的效率是比较高的，我们项目中用了unix系统的ucontext函数，实现了基本的协程功能，在实际使用中效率不太高，但是也足够用。 记录一下ucontext的原理和使用。</p>
<h2 id="ucontext">ucontext</h2><p>先看一个简单的例子，来自维基百科：</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;ucontext.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span>

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span>
</span>{
    <span class="keyword">ucontext_t</span> context;
    getcontext(&amp;context);
    <span class="built_in">puts</span>(<span class="string">"Hello world"</span>);
    sleep(<span class="number">1</span>);
    setcontext(&amp;context);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>这个程序的运行结果是这样的：</p>
<pre><code>[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>vim test.cpp
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>g++ test.cpp -o test
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>./test 
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
<span class="constant">Hello</span> world
^<span class="constant">C</span>
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>
</code></pre><p><code>getcontext</code>得到了当前的上下文，然后输出<code>Hello world</code>，然后调用<code>setcontext</code>，又跳到了调用<code>getcontext</code>的位置，接着输出<code>Hello world</code>，一直循环下去。。。。</p>
<hr>
<p>ucontext很简洁，头文件 <code>&lt;ucontext.h&gt;</code> ，两个结构体<code>mcontext_t</code>和<code>ucontext_t</code>，<br>四个函数<code>getcontext()</code>,<code>setcontext()</code>,<code>makecontext()</code>,<code>swapcontext()</code>，这些内容就可以实现协程。</p>
<p><code>mcontext_t</code>应该是系统需要传递的参数，是用户无关的，用户只需要关心<code>ucontext_t</code>结构和<br><code>getcontext()</code>,<code>setcontext()</code>,<code>makecontext()</code>,<code>swapcontext()</code>，下面详细介绍一个结构体和四个函数：</p>
<pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> ucontext {
          <span class="keyword">struct</span> ucontext *uc_link;
          <span class="keyword">sigset_t</span>         uc_sigmask;
          <span class="keyword">stack_t</span>          uc_stack;
          <span class="keyword">mcontext_t</span>       uc_mcontext;
          ...
      } <span class="keyword">ucontext_t</span>;
</code></pre><p><code>ucontext_t</code>中<code>uc_link</code>指向后继上下文，当前上下文如果执行结束会跳转到<code>uc_link</code>指向的上下文中运行，如果<code>uc_link</code>为<code>NULL</code>那么当前线程直接退出。<br><code>uc_stack</code> 设置当前上下文的堆栈大小和位置。<br>其他参数暂时没用到，具体用到之后再补充</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">getcontext</span><span class="params">(ucontext_t *ucp)</span></span>;
</code></pre><p>初始化ucp结构体，将当前的上下文保存到ucp中</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">setcontext</span><span class="params">(<span class="keyword">const</span> ucontext_t *ucp)</span></span>;
</code></pre><p>设置当前的上下文为<code>ucp</code>，<code>setcontext</code>的上下文ucp应该通过<code>getcontext</code>或者<code>makecontext</code>取得，如果调用成功则不返回。如果上下文是通过调用<code>getcontext()</code>取得,程序会继续执行这个调用。如果上下文是通过调用<code>makecontext</code>取得,程序会调用<code>makecontext</code>函数的第二个参数指向的函数，如果<code>func</code>函数返回,则恢复<code>makecontext</code>第一个参数指向的上下文第一个参数指向的上下文<code>context_t</code>中指向的uc_link.如果<code>uc_link</code>为<code>NULL</code>,则线程退出。</p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">makecontext</span>(<span class="params">ucontext_t *ucp, <span class="keyword">void</span> (*func</span>)(<span class="params"></span>), <span class="keyword">int</span> argc, ...)</span>;
</code></pre><p><code>makecontext</code>修改通过<code>getcontext</code>取得的上下文<code>ucp</code>(这意味着调用<code>makecontext</code>前必须先调用<code>getcontext</code>)。然后给该上下文指定一个栈空间<code>ucp-&gt;stack</code>，设置后继的上下文<code>ucp-&gt;uc_link</code>.</p>
<p>当上下文通过<code>setcontext</code>或者<code>swapcontext</code>激活后，执行<code>func</code>函数，<code>argc</code>为<code>func</code>的参数个数，后面是<code>func</code>的参数序列。当<code>func</code>执行返回后，继承的上下文被激活，如果继承上下文为<code>NULL</code>时，线程退出。</p>
<pre><code>int swapcontext<span class="list">(<span class="keyword">ucontext_t</span> <span class="variable">*oucp, ucontext_t *</span>ucp)</span><span class="comment">;</span>
</code></pre><p>保存当前上下文到oucp结构体中，然后激活ucp上下文。</p>
<p>如果执行成功，<code>getcontext</code>返回0，<code>setcontext</code>和<code>swapcontext</code>不返回；<br>如果执行失败，<code>getcontext</code>,<code>setcontext</code>,<code>swapcontext</code>返回-1，并设置相应的errno.</p>
<p>简单说来， <code>getcontext</code>获取当前上下文，<code>setcontext</code>设置当前上下文，<br><code>swapcontext</code>保存当前上下文并切换上下文，<code>makecontext</code>创建一个新的上下文。</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;ucontext.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>

<span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">void</span> * arg)</span>
</span>{
    <span class="built_in">puts</span>(<span class="string">"func1"</span>);
}
<span class="function"><span class="keyword">void</span> <span class="title">context_test</span><span class="params">()</span>
</span>{
    <span class="keyword">char</span> <span class="built_in">stack</span>[<span class="number">1024</span>*<span class="number">128</span>];
    <span class="keyword">ucontext_t</span> child,main;

    getcontext(&amp;child); <span class="comment">//获取当前上下文</span>
    child.uc_stack.ss_sp = <span class="built_in">stack</span>;<span class="comment">//指定栈空间</span>
    child.uc_stack.ss_size = <span class="keyword">sizeof</span>(<span class="built_in">stack</span>);<span class="comment">//指定栈空间大小</span>
    child.uc_stack.ss_flags = <span class="number">0</span>;
    child.uc_link = &amp;main;<span class="comment">//设置后继上下文</span>

    makecontext(&amp;child,(<span class="keyword">void</span> (*)(<span class="keyword">void</span>))func1,<span class="number">0</span>);<span class="comment">//修改上下文指向func1函数</span>

    swapcontext(&amp;main,&amp;child);<span class="comment">//保存当前上下文到main，切换到child上下文</span>
    <span class="built_in">puts</span>(<span class="string">"main"</span>);<span class="comment">//如果设置了后继上下文，func1函数指向完后会返回此处</span>
}

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    context_test();

    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>这个例子中，<code>getcontext</code>首先获得了当前的上下文，<code>child</code>参数相当于一个输出，通过<code>getcontext</code>函数把当前上下文的信息写入到<code>child</code>中。然后修改了<code>child</code>上下文的栈空间和大小，以及后继上下文，然后调用<code>makecontext</code>，这时<code>child</code>相当于输入，将<code>child</code>上下文的执行位置指向<code>func1</code>，最后调用<code>swapcontext</code>，<code>main</code>和<code>child</code>都是输入，将当前的上下文保存到<code>main</code>中，然后切换到<code>child</code>上下文(此时的<code>child</code>上下文位置是<code>func1</code>函数的起点)。 这样这个程序执行后的输出就是：</p>
<pre><code>[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>vim test.cpp
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>g++ test.cpp -o test
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>./test 
func1
main
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>
</code></pre><p>可以看到当程序执行到<code>swapcontext</code>后，程序通过<code>child</code>上下文跳转到了<code>func1</code>，先执行了<code>puts(&quot;func1&quot;)</code>; 函数执行结束后跳转到<code>child</code>的后继上下文<code>main</code>，也就是调用<code>swapcontext</code>时保存起来的上下文，这样程序又回到了<code>swapcontext</code>执行结束的位置（因为<code>swapcontext</code>执行成功不返回，<code>swapcontext</code>已经执行成功，所以跳转回来之后程序的位置在<code>swapcontext</code>的下一句）并执行<code>puts(&quot;main&quot;)</code>;</p>
<p>上面的程序在执行完<code>child</code>上下文后能够跳到<code>main</code>上下文是因为设置了<code>child</code>的后继上下文<code>child.uc_link = &amp;main</code>，如果我们把这一句改为<code>child.uc_link = NULL</code>，编译执行后得到如下结果</p>
<pre><code>[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>vim test.cpp
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>g++ test.cpp -o test
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>./test 
func1
[shafeng<span class="variable">@localhost</span> <span class="constant">Desktop</span>]<span class="variable">$ </span>
</code></pre><p>可以看到<code>child</code>上下文在执行结束之后就直接退出了线程。 所以上下文的后继上下文很重要，否则我们的程序可能直接退出。</p>
<h2 id="总结">总结</h2><p>以上就是ucontext的全部内容，非常简洁。我们项目中使用的就是ucontext，后面再记录一下项目中的实际使用情况。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-06-27T07:46:53.000Z"><a href="/2017/06/27/gstack_strace/">2017-06-27</a></time>
      
      
  
    <h1 class="title"><a href="/2017/06/27/gstack_strace/">关于线上程序排错的一些命令 gstack,strace,gcore(Linux)</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="关于Linux程序运行中查看堆栈的一些命令">关于Linux程序运行中查看堆栈的一些命令</h2><pre><code>最近项目上遇到一些问题，服务器程序在运行的时候cpu特别高，尤其是逻辑线程，一度达到<span class="number">99</span>%。为了查找问题，使用了一些之前没有用过的命令，加上我之前用过的几个命令，写一篇记录
</code></pre><h3 id="gstack">gstack</h3><pre><code>gstack 线程<span class="property">id</span>,例如:gstack <span class="number">2939</span>,可以查看到当前线程的堆栈信息,如果程序的当前线程占cpu特别高,可能会出现死循环或者其他症状,我们可以通过使用gstack命令查看当前线程的堆栈信息来诊断问题.
</code></pre><h3 id="strace">strace</h3><pre><code>strace -T -r -c -<span class="tag">p</span> 线程id,例如:strace -T -r -c -<span class="tag">p</span> <span class="number">2939</span>,可以得到当前线程的所有系统调用统计,停止统计的时候必须自己手动退出,会输出使用命令到停止统计期间的信息.
</code></pre><h3 id="gcore">gcore</h3><pre><code>gcore 进程<span class="property">id</span>,例如:gcore <span class="number">12345</span>,可以得到当前进程的所有线程的堆栈信息.
</code></pre><p>一些总结,通过以上这些命令可以间接观察到程序当前的运行状态和运行位置.给予程序开发者更多的讯息以诊断程序当前可能出现的问题,有一个需要注意的地方,gstack和strace在运行期间不会影响到程序本身的运行,而gcore会将程序暂停,影响程序的正常工作.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-06-10T04:00:00.000Z"><a href="/2017/06/10/mysql/">2017-06-10</a></time>
      
      
  
    <h1 class="title"><a href="/2017/06/10/mysql/">mysql 优化配置和一些参数的解释</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Mysql的一些性能优化记录">Mysql的一些性能优化记录</h2><p>项目上经过合服等操作,单服的玩家数量一度超过500W,一些排行榜数据和玩家摘要数据在程序启动时就要从数据库中加载,数据量的增大也延长了服务器程序的启动时间,一些必要的优化就在所难免了.贴一下数据的配置.做一下记录</p>
<pre><code>[client]
<span class="constant">socket</span> = /tmp/mysql.sock


[mysqld_multi]
<span class="constant">log</span>        = /data/mysql_db/mysqld_multi.log
<span class="constant">mysqld</span>     = /usr/bin/mysqld_safe
<span class="constant">mysqladmin</span> = /usr/bin/mysqladmin
<span class="constant">user</span>       = shutdown_user

<span class="comment">###########################################################################################</span>
[mysqld4306]
<span class="constant">port</span>       = 4306
<span class="constant">socket</span>     = /tmp/mysql_4306.sock
pid-file   = /tmp/mysql_4306.pid
<span class="constant">datadir</span>    = /data/mysql_db/4306
<span class="constant">default_storage_engine</span> = InnoDB
<span class="constant">sql_mode</span>=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
skip-name-resolve
<span class="constant">max_connections</span> = 1000
<span class="constant">innodb_flush_log_at_trx_commit</span> = 2
<span class="constant">innodb_flush_log_at_timeout</span>     =1
<span class="constant">innodb_buffer_pool_size</span> = 24080M
<span class="constant">innodb_log_buffer_size</span> = 8M
<span class="constant">innodb_log_file_size</span> = 256M
log-bin=/data/mysql_binlog/4306/mysql-bin
<span class="constant">binlog_format</span>=MIXED
<span class="constant">binlog_cache_size</span> = 1M
<span class="constant">max_binlog_size</span>=512M
log_warnings
slow_query_log
<span class="constant">long_query_time</span> = 2
server-id = 1
<span class="constant">expire_logs_days</span> = 5
secure-file-priv=
<span class="constant">tmpdir</span>=/data/mysql_tmp
</code></pre><p>innodb_buffer_pool_size 这个选项调大可以增加innodb的内存大小,减少io操作<br>expire_logs_days 这个选项可以指定binlog保存的天数,binlog占用硬盘空间特别大,但是binlog又是恢复数据库时最宝贵的log,所以如何权衡这个问题还得结合自己项目的需要<br>secure-file-priv= 这个选项可以让其他用户写入数据,项目在合服时无法写入数据,加入这个配置可以降低数据库的安全性检查<br>tmpdir=/data/mysql_tmp 这个选项可以指定mysql在运行时使用的硬盘空间地址,默认的地址是在系统盘,而一般系统盘的空间较小,把目录指定到空间较大的目录可以有效提高数据库的io效率</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-05-10T07:55:00.000Z"><a href="/2017/05/10/asan/">2017-05-10</a></time>
      
      
  
    <h1 class="title"><a href="/2017/05/10/asan/">ASan(Linux)，gcc4.8以上版本自带的内存检查工具</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="惊天大霹雳，超级好用的Linux程序内存检查工具，AddressSanitizer_(ASan)">惊天大霹雳，超级好用的Linux程序内存检查工具，AddressSanitizer (ASan)</h2><p>最近线上的程序总是莫名其妙崩溃,因为我们的项目使用了分布负载的机制,对于玩家的影响其实很小,但是我肯定是忍不了的…程序崩溃的core文件里面完全找不到问题所在,初步分析应该是野指针导致,仔细分析程序之后并没有发现内存释放后没有置null的情况,很可能是多线程导致的,然而代码量太大,大海捞针实在是无法找到问题所在,所以我找到了asan,项目之前一直用gcc4.4编译,完全不知道asan的存在,asan是gcc4.8以上gcc自带的内存检测库,开发自google,在gcc4.8版本以上编译链接的时候加入指定的参数即可,非常的方便好用,而且对程序的性能影响并不大,如果你的程序平时耗费的cpu和内存资源不超过50%,那么完全可以把加入asan的程序放到线上去跑.</p>
<p>首先在编译机上升级gcc,我直接升级到了最新版本gcc6.3版本(写这篇记录的时候最新版已经到gcc7.1了),升级后系统库中会新加入libasan,我们使用asan的功能都是来自于这里.<br>然后对代码进行编译和链接,编译时使用 -g -O2 -fsanitize=address -fno-omit-frame-pointer .-fsanitize=address命令就是将asan编译进来,这样编译的.o文件在运行时stack上申请的内存都会被asan接管,如果出问题asan会第一时间输出报告,如内存越界和各种非法访问. -fno-omit-frame-pointer可以防止一些优化导致指针丧失可读性.  链接时使用-fsanitize=address -fno-omit-frame-pointer选项可以让程序在heap上申请的内存被asan接管,这样asan会监控new和delete来输出内存泄漏的报告.</p>
<p>大功告成,使用asan编译和链接的程序生成好之后放到了线上环境运营,很快出现了一次宕机,asan会直接把自己的输出当做error输出,你可以查看到当前导致宕机的内存位置和变量名,文件行数,变量来源,线程信息等等非常全面的信息,得到这些信息后很快就分析出原来崩溃来自一个多线程共享的模块,而当前模块在多线程竞争资源的地方没有加锁,导致同一块内存被写坏. 问题完美解决,程序再也不会宕机了.</p>
<p>总结一下,asan在检测程序内存方面的功能实在是强大,之前也用过valgrind来检查内存泄漏,但是valgrind对性能的影响实在是太大,完全不能放到线上环境这样真实的环境下测试,而且asan给出的问题报告相当详细,基本上看一次错误报告就能解决当前导致宕机的问题,而core文件的信息由于优化和其他程序上下文的差异会导致提供的信息基本上没什么作用.宕机十次,十个core文件也无法准确定位某些野指针错误的问题.对于asan,只有一个词能表达我的心情,那就是相见恨晚…asan你值得拥有,谁用谁知道.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-11-25T04:00:00.000Z"><a href="/2016/11/25/行为树/">2016-11-25</a></time>
      
      
  
    <h1 class="title"><a href="/2016/11/25/行为树/">AI行为树</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="用行为树来控制AI行为">用行为树来控制AI行为</h1>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-08T09:07:00.000Z"><a href="/2016/05/08/vsftpd/">2016-05-08</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/08/vsftpd/">Linux上vsftpd的搭建和使用</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Linux上vsftpd的搭建和使用">Linux上vsftpd的搭建和使用</h2><p>1.查看是否安装vsftp</p>
<pre><code>rpm -<span class="keyword">qa</span> | <span class="keyword">grep</span> vsftpd
</code></pre><p>   如果出现：</p>
<pre><code><span class="tag">vsftpd-3</span><span class="class">.0</span><span class="class">.2-10</span><span class="class">.el7</span><span class="class">.x86_64</span>
</code></pre><p>   说明已经安装了vsftpd，如果没有安装<br>   使用命令安装：</p>
<pre><code>yum -y <span class="keyword">install</span> vsftpd
</code></pre><p>2,配置vsftpd</p>
<pre><code><span class="title">whereis</span> vsftpd
</code></pre><p>   出现：</p>
<pre><code><span class="string">vsftpd:</span> <span class="regexp">/usr/</span>sbin<span class="regexp">/vsftpd /</span>etc<span class="regexp">/vsftpd /</span>usr<span class="regexp">/share/</span>man<span class="regexp">/man8/</span>vsftpd<span class="number">.8</span>.gz
</code></pre><p>   到 /etc/vsftpd 目录下配置 vsftpd.conf</p>
<pre><code><span class="setting">pam_service_name=<span class="value">vsftpd             //设置服务名字，防火墙设置里要用</span></span>
<span class="setting">userlist_enable=<span class="value"><span class="keyword">YES</span>                 //访问限制打开</span></span>
<span class="setting">tcp_wrappers=<span class="value"><span class="keyword">YES</span>                    //防火墙打开</span></span>
<span class="setting">local_root=<span class="value">/haizhan                 //ftp的根目录</span></span>
<span class="setting">listen_port=<span class="value"><span class="number">19008</span>                   //修改ftp的默认端口<span class="number">21</span>到<span class="number">19008</span></span></span>
<span class="setting">listen=<span class="value"><span class="keyword">YES</span>                      </span></span>
<span class="setting">pasv_min_port=<span class="value"><span class="number">19010</span>                 //pasv模式分配给客户端可以连接的端口范围</span></span>
<span class="setting">pasv_max_port=<span class="value"><span class="number">19020</span></span></span>
<span class="setting">pasv_promiscuous=<span class="value"><span class="keyword">YES</span>                //关闭pasv的安全检查</span></span>
<span class="setting">pasv_enable=<span class="value"><span class="keyword">YES</span>                     //使用pasv模式</span></span>
<span class="setting">pasv_addr_resolve=<span class="value"><span class="keyword">YES</span>               //设置外网地址开关</span></span>
<span class="setting">pasv_address=<span class="value"><span class="number">120.120</span>.<span class="number">120.120</span>        //如果这台机器需要对外网提供ftp的pasv服务，需要在这里设置本机外网地址</span></span>
<span class="setting">listen_ipv6=<span class="value"><span class="keyword">NO</span>                      //关闭ipv6才能正常工作</span></span>
</code></pre><p>上面这些配置全部是必要配置，必须全部配置。</p>
<p>3,修改FTP系统默认端口<br>   修改 /etc/services</p>
<pre><code>ftp             <span class="number">19008</span>/tcp
ftp             <span class="number">19008</span>/udp
</code></pre><p>4,配置访问限制<br>  1.修改/etc/hosts.deny<br>  加入 :</p>
<pre><code><span class="keyword">vsftpd</span>:<span class="literal">ALL</span>
</code></pre><p>  2.修改/etc/hosts.allow<br>  加入白名单ip，如：</p>
<pre><code>vsftpd:<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>
vsftpd:<span class="number">120.1</span><span class="number">.1</span><span class="number">.1</span>
vsftpd:<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   <span class="comment">//限定网段的，没有试过。</span>
</code></pre><p> 5,添加用户</p>
<pre><code>useradd <span class="operator">-d</span> /zhanjian <span class="operator">-s</span> /sbin/nologin haizhan
passwd haizhan
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-11-12T09:18:53.000Z"><a href="/2015/11/12/explicit&extern/">2015-11-12</a></time>
      
      
  
    <h1 class="title"><a href="/2015/11/12/explicit&extern/">C++中的explicit和extern</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="explicit">explicit</h2><p>C++提供了关键字explicit，可以阻止不应该允许的经过转换构造函数进行的隐式转换的发生。声明为explicit的构造函数不能在隐式转换中使用<br>C++中， 一个参数的构造函数(或者除了第一个参数外其余参数都有默认值的多参构造函数)， 承担了两个角色。 1 是个构造器 ，2 是个默认且隐含的类型转换操作符。<br>explicit构造函数是用来防止隐式转换的。请看下面的代码：<br>    <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Test1</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	Test1(<span class="keyword">int</span> n)</span><br><span class="line">	&#123;</span><br><span class="line">		num=n;</span><br><span class="line">	&#125;<span class="comment">//普通构造函数</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> Test2</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">Test2</span><span class="params">(<span class="keyword">int</span> n)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		num=n;</span><br><span class="line">	&#125;<span class="comment">//explicit(显式)构造函数</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	Test1 t1=<span class="number">12</span>;<span class="comment">//隐式调用其构造函数,成功</span></span><br><span class="line">	Test2 t2=<span class="number">12</span>;<span class="comment">//编译错误,不能隐式调用其构造函数</span></span><br><span class="line">	<span class="function">Test2 <span class="title">t2</span><span class="params">(<span class="number">12</span>)</span></span>;<span class="comment">//显式调用成功</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只要是构造函数中只有一个可变参数的C++类，都要避免隐式调用。</p>
<h2 id="extern">extern</h2><h3 id="extern可置于变量或者函数前，以表示变量或者函数的定义在别的文件中，提示编译器遇到此变量或函数时，在其它模块中寻找其定义。">extern可置于变量或者函数前，以表示变量或者函数的定义在别的文件中，提示编译器遇到此变量或函数时，在其它模块中寻找其定义。</h3><p>下面这段代码没有使用任何 extern 关键字，编译中会报错。<br>    <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A.cpp</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//B.cpp</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br></pre></td></tr></table></figure></p>
<p>添加extren关键字后可以编译通过，提示编译器i变量定义在其他模块中<br>    <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A.cpp</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> i;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	i=<span class="number">100</span>;<span class="comment">//试图使用B中定义的全局变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//B.cpp</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br></pre></td></tr></table></figure></p>
<h3 id="extern也可用来进行链接指定。">extern也可用来进行链接指定。</h3><p>C++支持函数重载，而过程式语言C则不支持。函数被C++编译后在符号库中的名字与C语言的不同。例如，假设某个函数的原型为：<br>void foo( int x, int y );该函数被C编译器编译后在符号库中的名字为_foo，而C++编译器则会产生像_foo_int_int之类的名字<br>（不同的编译器可能生成的名字不同，但是都采用了相同的机制，生成的新名字称为“mangled name”）。_foo_int_int这样的名字<br>包含了函数名、函数参数数量及类型信息，C++就是靠这种机制来实现函数重载的。例如，在C++中，函数void foo( int x, int y )<br>与void foo( int x, float y )编译生成的符号是不相同的，后者为_foo_int_float。同样地，C++中的变量除支持局部变量外，<br>还支持类成员变量和全局变量。用户所编写程序的类成员变量可能与全局变量同名，我们以”.”来区分。而本质上，编译器在进行编译时，<br>与函数的处理相似，也为类中的变量取了一个独一无二的名字，这个名字与用户程序中同名的全局变量名字不同。<br>在C++中引用C语言中的函数和变量，在包含C语言头文件（假设为cExample.h）时，需进行下列处理：<br>    <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">include</span> <span class="string">"cExample.h"</span>	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-09-01T04:00:00.000Z"><a href="/2015/09/01/epoll/">2015-09-01</a></time>
      
      
  
    <h1 class="title"><a href="/2015/09/01/epoll/">epoll的使用</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="epoll">epoll</h1>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-21T09:49:39.000Z"><a href="/2015/05/21/二义性/">2015-05-21</a></time>
      
      
  
    <h1 class="title"><a href="/2015/05/21/二义性/">关于C++继承的二义性</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="关于C++继承的二义性">关于C++继承的二义性</h2><p>天气太热写不下去代码,就翻柜子,找到c++primer翻了一下,好久不看书,记一下翻到的内容,稍微巩固下…<br>给定下面的类层次，从 VMI 类内部可以限定地访问哪些继承成员？哪些继承成员需要限定？解释你的推理。</p>
<pre><code><span class="keyword">class</span> Base {
<span class="keyword">public</span>:
    bar(<span class="keyword">int</span>);
<span class="keyword">protected</span>:
    <span class="keyword">int</span> ival;
};
<span class="keyword">class</span> Derived1 : <span class="keyword">virtual</span> <span class="keyword">public</span> Base {
<span class="keyword">public</span>:
    bar(<span class="keyword">char</span>);
    foo(<span class="keyword">char</span>);
<span class="keyword">protected</span>:
    <span class="keyword">char</span> cval;
};
<span class="keyword">class</span> Derived2 : <span class="keyword">virtual</span> <span class="keyword">public</span> Base {
<span class="keyword">public</span>:
    foo(<span class="keyword">int</span>);
<span class="keyword">protected</span>:
    <span class="keyword">int</span> ival;
    <span class="keyword">char</span> cval;
};
<span class="keyword">class</span> VMI : <span class="keyword">public</span> Derived1, <span class="keyword">public</span> Derived2 { };
</code></pre><p>从这个继承层次看，VMI类内部访问哪些没有二义性，哪些成员有二义性呢？<br>从VMI类内部可以不加限定地访问继承成员bar和ival：bar在共享基类Base和派生类Derived1中都存在，但特定派生类实例的优先级高于共享基类实例，所以在VMI类内部不加限定地访问bar，则访问到的是Derived1中的bar实例。ival在共享基类Base和派生类Derived2中都存在，同理，在VMI类中不加限定地访问ival，访问到的是Derived2中的ival实例。<br>继承成员foo和cval需要限定：二者在Derived1和Derived2中都存在，Derived1和Derived2均为Base的派生类，访问优先级相同，所以，如果在VMI类内不加限定地访问foo和cval，则会出现二义性。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-21T09:49:39.000Z"><a href="/2015/05/21/c++11 bind的使用/">2015-05-21</a></time>
      
      
  
    <h1 class="title"><a href="/2015/05/21/c++11 bind的使用/">C++11中bind,function实战记录</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="C++11中bind和function的使用">C++11中bind和function的使用</h3><p>最近在做的项目中有一个需求,我负责向客户端推送一组数据,这些数据需要另一个服务器程序员填充,<br>我需要调用他的一个函数,并把我的填充函数传递给他,然后在他的函数中填充这些数据.</p>
<p>首先我用普通函数试验了一下,因为c++11中的bind和function并没有使用过太多.<br>``` c++</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span>
<span class="keyword">struct</span> Info;
<span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;Info*()&gt; NewInfo;
<span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span> (<span class="keyword">int</span> key,<span class="keyword">int</span> value)&gt; PropExecute;
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::placeholders;

<span class="keyword">struct</span> Info
{
    <span class="keyword">int</span> key;
    <span class="keyword">int</span> value;
};

<span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(PropExecute func)</span>
</span>{
    func(<span class="number">1</span>,<span class="number">1</span>);
}
<span class="function"><span class="keyword">void</span> <span class="title">prop</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value,NewInfo f)</span>
</span>{
    Info* info = f();
    info-&gt;key = key;
    info-&gt;value = value;
}
<span class="function">Info* <span class="title">new_info</span><span class="params">()</span>
</span>{
    <span class="keyword">return</span> <span class="keyword">new</span> Info;
}

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    test(bind(prop,_1,_2,new_info));
    <span class="keyword">return</span> <span class="number">1</span>;
}
</code></pre><p>这样写就基本实现了该功能,<code>Info</code>和<code>PropExecute</code>函数类型由我公开给服务器同事,<br>同事提供<code>test</code>函数给我调用,并在该函数内使用我传递过去的函数将数据填充(这里我用1,1填充).</p>
<p>好了,现在修改一下,把所有的普通函数都修改为类成员函数,因为项目中这些函数都是类成员函数.</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span>
<span class="keyword">struct</span> Info;
<span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;Info*()&gt; NewInfo;
<span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span> (<span class="keyword">int</span> key,<span class="keyword">int</span> value)&gt; PropExecute;
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::placeholders;
<span class="keyword">class</span> Attr
{
<span class="keyword">public</span>:
    Attr():key(<span class="number">1</span>),value(<span class="number">1</span>){}
    ~Attr(){};
    <span class="function"><span class="keyword">void</span> <span class="title">get_attr</span><span class="params">(PropExecute func)</span>
    </span>{
        func(key,value);
    }
    <span class="keyword">int</span> key;
    <span class="keyword">int</span> value;
};
<span class="keyword">class</span> Info
{
<span class="keyword">public</span>:
    Info():key(<span class="number">0</span>),value(<span class="number">0</span>){};
    ~Info(){};
    <span class="function">Info* <span class="title">new_info</span><span class="params">()</span>
    </span>{
        <span class="keyword">return</span> <span class="keyword">new</span> Info;
    }
    <span class="keyword">int</span> key;
    <span class="keyword">int</span> value;
};
<span class="keyword">class</span> MyClass
{
<span class="keyword">public</span>:
    MyClass(){}
    ~MyClass(){}
    <span class="function"><span class="keyword">void</span> <span class="title">set_prop</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value,NewInfo f)</span>
    </span>{
        Info* info = f();
        info-&gt;key = key;
        info-&gt;value = value;
    }
};


<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    Info info;
    Attr attr;
    MyClass myclass;
    NewInfo newinfo = <span class="built_in">std</span>::bind(&amp;Info::new_info,&amp;info);
    attr.get_attr(bind(&amp;MyClass::set_prop,&amp;myclass,_1,_2,newinfo));
    <span class="keyword">return</span> <span class="number">1</span>;
}
</code></pre><p>修改为类成员函数后就是这样了,这里遇到一个问题,<code>main</code>函数中调用<code>get_attr</code>时分成了两条代码,<br>因为写成这样编译报错<code>attr.get_attr(bind(&amp;MyClass::set_prop,&amp;myclass,_1,_2,std::bind(&amp;Info::new_info,&amp;info)));</code><br>我估计可能是类型不匹配之类的错误.总之分成两条代码就OK了. </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-04-09T09:15:53.000Z"><a href="/2015/04/09/orm-odb/">2015-04-09</a></time>
      
      
  
    <h1 class="title"><a href="/2015/04/09/orm-odb/">orm-odb(c++)，一种对象关系映射数据操作方式</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="基于ORM机制的C++数据库操作开源库ODB">基于ORM机制的C++数据库操作开源库ODB</h2><p>  最近在项目里遇到一个问题,关于数据库读取大量数据的,这部分代码项目里的思路是,对数据表做索引,然后依据索引排序,取出最上面的max_size(5000)条数据,然后基于后面的数据继续排序,取出最上面max_size(5000)条,依此循环直到取出最后一条数据.  开始我觉得这样可能效率会比较低,因为每次操作都要进行一次排序,我觉得用limit 0,max_size .limit 0+max_size,max_size+max_size这样的方法要快一些,后来想了一下问题的关键应该是在每次取第一条数据的时候,比如先排序再去取的话,因为建立了索引,所以排序是很快的,而且第一条马上就找到了,但是用limit 0,max_size这样的方法的话,每次查找第一条数据都要顺序数到位置,所以先排序再取数据的方法是稍微好一点的. </p>
<hr>
<p>  不过正是因为这个问题,偶然发现了一个c++的数据库操作库,基于ORM机制,google了一下ORM,全称是对象关系映射（Object Relational Mapping),简单来说就是使用这个库可以让程序员避免直接操作sql语句,数据的存储和对象直接相关,多说无益,记下使用方法以便日后用得到.</p>
<hr>
<p> 我是在windows平台上编译和测试的.这里记下windows下的使用方法:<br> 首先从<a href="http://www.codesynthesis.com/products/odb/" target="_blank" rel="external">http://www.codesynthesis.com/products/odb/</a> 下载到源码,主要是the Common Runtime Library和the Database Runtime Library,前者是ODB的基本库,后者是基于不同数据库的扩展库,后者要基于前者.我用的是mysql,所以要下载mysql的扩展库.前者没有任何依赖可以直接编译,后者要基于前者和mysql的库,我编译的时候总是不成功,后来发现我机器上安装的mysql是64位的,编译ODB的时候把win32改成X64后编译通过,以后要注意下这个问题.使用编译好的库启动官方的例子程序”hello”,一切正常.<br> 简单的用法如下:</p>
<p> 这是一个简单的person类.<br> // person.hxx</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span>

<span class="keyword">class</span> person
{
<span class="keyword">public</span>:
  person (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; first,
          <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; last,
          <span class="keyword">unsigned</span> <span class="keyword">short</span> age);

  <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span>&amp; <span class="title">first</span> <span class="params">()</span> <span class="keyword">const</span></span>;
  <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span>&amp; <span class="title">last</span> <span class="params">()</span> <span class="keyword">const</span></span>;

  <span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">age</span> <span class="params">()</span> <span class="keyword">const</span></span>;
  <span class="function"><span class="keyword">void</span> <span class="title">age</span> <span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span>)</span></span>;

<span class="keyword">private</span>:
  <span class="built_in">std</span>::<span class="built_in">string</span> first_;
  <span class="built_in">std</span>::<span class="built_in">string</span> last_;
  <span class="keyword">unsigned</span> <span class="keyword">short</span> age_;
};
</code></pre><p> 使用ODB后修改如下:</p>
<p> // person.hxx</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span>

<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;odb/core.hxx&gt;</span>     // (1)</span>

<span class="preprocessor">#<span class="keyword">pragma</span> db object           <span class="comment">// (2)</span></span>
<span class="keyword">class</span> person
{
  ...

<span class="keyword">private</span>:
  person () {}              <span class="comment">// (3)</span>

  <span class="keyword">friend</span> <span class="keyword">class</span> odb::access; <span class="comment">// (4)</span>

  <span class="preprocessor">#<span class="keyword">pragma</span> db id auto        <span class="comment">// (5)</span></span>
  <span class="keyword">unsigned</span> <span class="keyword">long</span> id_;        <span class="comment">// (5)</span>

  <span class="built_in">std</span>::<span class="built_in">string</span> first_;
  <span class="built_in">std</span>::<span class="built_in">string</span> last_;
  <span class="keyword">unsigned</span> <span class="keyword">short</span> age_;
};
</code></pre><p> 使用这个sql文件建立数据表<br> //This file was generated by ODB, object-relational mapping (ORM) compiler for C++.</p>
<pre><code><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`person`</span>;</span>

<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`person`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT,
  <span class="string">`first`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,
  <span class="string">`last`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,
  <span class="string">`age`</span> <span class="built_in">SMALLINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>)
 <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span>
</code></pre><p>测试例子如下,执行commit函数后三个person类对象的数据就写入了数据库中,真的非常方便简洁.<br> //driver.cxx</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span>   // std::auto_ptr</span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span>

<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;odb/database.hxx&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;odb/transaction.hxx&gt;</span></span>

<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;odb/mysql/database.hxx&gt;</span></span>

<span class="preprocessor">#<span class="keyword">include</span> <span class="string">"person.hxx"</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">"person-odb.hxx"</span></span>

using namespace std<span class="comment">;</span>
using namespace odb::core<span class="comment">;</span>

<span class="built_in">int</span>
main (<span class="built_in">int</span> argc, char* argv[])
{
  try
  {
    //auto_ptr&lt;database&gt; db (new odb::mysql::database (argc, argv))<span class="comment">;</span>
    auto_ptr&lt;database&gt; db (new odb::mysql::database(<span class="string">"dll"</span>,<span class="string">"dll"</span>,<span class="string">"odb_test"</span>,<span class="string">"localhost"</span>,<span class="number">3306</span>))<span class="comment">;</span>
    unsigned long john_id, jane_id, joe_id<span class="comment">;</span>

    // Create a few persistent person objects.
    //
    {
      person john (<span class="string">"John"</span>, <span class="string">"Doe"</span>, <span class="number">33</span>)<span class="comment">;</span>
      person jane (<span class="string">"Jane"</span>, <span class="string">"Doe"</span>, <span class="number">32</span>)<span class="comment">;</span>
      person joe (<span class="string">"Joe"</span>, <span class="string">"Dirt"</span>, <span class="number">30</span>)<span class="comment">;</span>

      transaction t (db-&gt;begin ())<span class="comment">;</span>

      // Make objects persistent <span class="literal">and</span> save their ids <span class="keyword">for</span> later use.
      //
      john_id = db-&gt;persist (john)<span class="comment">;</span>
      jane_id = db-&gt;persist (jane)<span class="comment">;</span>
      joe_id = db-&gt;persist (joe)<span class="comment">;</span>

      t.commit ()<span class="comment">;</span>
    }
  }
  catch (<span class="keyword">const</span> odb::exception&amp; e)
  {
    cerr &lt;&lt; e.what () &lt;&lt; endl<span class="comment">;</span>
    <span class="keyword">return</span> <span class="number">1</span><span class="comment">;</span>
  }
}
</code></pre><p>这是ODB官方自带的例子,我们在使用ODB的时候需要自己生成person类的C++文件,使用官方的ODB Compiler,下载后将ODB的bin目录添加到系统的环境变量中,通过person.hxx文件即可得到ODB需要的其他c++文件,类似protobuf的使用.<br>    odb -d mysql –generate-query –generate-schema person.hxx<br>这条命令即可生成person-odb.hxx, person-odb.ixx, person-odb.cxx这三个文件,这样配合编译好的库文件就可以操作数据库了.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-12T07:12:53.000Z"><a href="/2015/02/12/libcurl/">2015-02-12</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/12/libcurl/">Windows下编译libcurl</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Windows下libcurl静态库的编译和使用">Windows下libcurl静态库的编译和使用</h2><p>  最近在玩一个游戏,这游戏的服务器是http通信的,就想伪造一些数据看看.想起了curl,于是去下载,结果编译半天总是出错,又浪费了好多时间,现在成功了,记下来.</p>
<hr>
<p> 首先从这里下载最新的源代码<br>  <a href="http://curl.haxx.se/download.html" target="_blank" rel="external">http://curl.haxx.se/download.html</a><br> libcurl是源码,curl是一个http的工具,反正我用libcurl的源码就够了.</p>
<p> 打开找到相应的VC版本工程用VS打开,我用的是VS2012,相应的版本是VC11.</p>
<p> 一开始编译出错,因为这个版本里包含了ssh和ssl的第三方库,我也用不着所以在预编译宏里把关于ssl和ssh的都去掉.</p>
<p> 然后继续编译lib静态库成功了,新建测试工程加入头文件和生成的附加库libcurld.lib,发现有无法识别的外部符号错误,网上找了半天解决方法.</p>
<p> 最后的解决方法是. libcurl的预编译设定为<br><code>WIN32</code><br><code>_DEBUG</code><br><code>BUILDING_LIBCURL</code><br> 测试项目的预编译设置为<br><code>BUILDING_LIBCURL</code><br> 并且在测试项目头文件中添加以下内容<br><code>#define CURL_STATICLIB</code><br><code>#if defined(_DEBUG)</code><br><code>#pragma comment(lib, &quot;libcurld.lib&quot;)</code><br><code>#else</code><br><code>#pragma comment(lib, &quot;libcurl.lib&quot;)</code><br><code>#endif</code><br><code>#pragma comment(lib,&quot;winmm.lib&quot; )</code><br><code>#pragma comment(lib,&quot;ws2_32.lib&quot; )</code><br><code>#pragma comment(lib,&quot;wldap32.lib&quot; )</code></p>
<p>再次编译,搞定.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-19T06:34:39.000Z"><a href="/2014/11/19/protobuf/">2014-11-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/19/protobuf/">xcode在os x下编译使用protobuf</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="os_x系统下xcode中使用protobuf">os x系统下xcode中使用protobuf</h2><p>最近在用cocos2dx做小游戏,希望用到网络部分,所以希望protobuf能在mac平台上工作,baidu和goole了一下后发现大部分都是重复的一两篇技术文章,转来转去,而且按照这两篇文章搞了一下都没有成功,后来发现了两篇实用的文章后才解决了问题,记录一下:</p>
<p>主要参考两篇在网上流传不广的文章.<br><code>http://blog.csdn.net/deep_coder/article/details/38055275</code><br><code>http://blog.csdn.net/rct1985/article/details/9340641</code></p>
<p>在 <code>https://code.google.com/p/protobuf/downloads/list</code> 这里下载最新的SourceCode工程, 我用的是2.5.0版本，下载完解压下指定目录下。</p>
<p>cd yourDir  </p>
<p>./configure<br>make<br>make check<br>sudo make install  </p>
<p>安装成功后在需要用到protobuf的xcode工程里:<br>a. 把解压完的目录下 protobuf-2.5.0/src/google整个目录拷贝到cocos2d-x工程下的libs目录下。<br>b. 把解压完的目录下 config.h 拷贝到 libs/google 目录下，主要是放到一些宏定义， 没办法，代码被引用了。<br>c. 删除编译多语言相关文件，google/protobuf/compiler 目录是用来编译多语言的，删除<br>d. 删除单元测试文件 所有 <em>*</em>unittest.cc 文件是测试用例（根据文件名猜的），删除, 还有两个tesst打着的文件夹</p>
<p>然后编译,会出现这个错误”#error Host architecture was not detected as supported by protobuf”</p>
<p>解决这个问题的方法是:</p>
<pre><code>In platform_macros<span class="class">.h</span>, Replace

<span class="id">#else</span>
<span class="id">#error</span> Host architecture was not detected as supported by protobuf
<span class="id">#endif</span>


By:
<span class="id">#elif</span> <span class="function"><span class="title">defined</span><span class="params">(__aarch64__)</span></span>
<span class="hexcolor">#def</span>ine GOOGLE_PROTOBUF_ARCH_ARM <span class="number">1</span>
<span class="hexcolor">#def</span>ine GOOGLE_PROTOBUF_ARCH_64_BIT <span class="number">1</span>
<span class="id">#else</span>
<span class="id">#error</span> Host architecture was not detected as supported by protobuf
#endif
</code></pre><p>最后再编译就OK了!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-19T15:19:38.000Z"><a href="/2014/03/19/gameloft-puyo/">2014-03-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/19/gameloft-puyo/">gameloft puyo（一种类俄罗斯方块游戏的代码）</a></h1>
  

    </header>
    <div class="entry">
      
        <pre><code>#头文件#
//tetris.h

#ifndef _TETRIS_H_
#define _TETRIS_H_

//#define _TETRIS_DEBUG

#include "include/glut.h"
#include "include/glpng.h"
#include &lt;list&gt;

#pragma comment(lib,"glpng.lib")

#define TETRIS_SCALE 2
#define TETRIS_SCREEN_WIDTH    ((GLint)(96*TETRIS_SCALE))
#define TETRIS_SCREEN_HEIGHT ((GLint)(192*TETRIS_SCALE))

#define TETRIS_INFO_WIDTH 120

#define TETRIS_KEY_ESCAPE 27
#define TETRIS_KEY_UP 72
#define TETRIS_KEY_DOWN 80
#define TETRIS_KEY_LEFT 75
#define TETRIS_KEY_RIGHT 77
#define TETRIS_KEY_SPACE  32
#define TETRIS_KEY_ENTER  13

#define TETRIS_TEXTURE_COUNT 4

#define TETRIS_UNIT_WIDTH 32
#define TETRIS_UNIT_HEIGHT 32

#define TETRIS_COLOR_BLUE 0
#define TETRIS_GREEN_BLUE 1
#define TETRIS_RED_BLUE 2
#define TETRIS_YELLOW_BLUE 3

#define TETRIS_UNITS_NUM (TETRIS_SCREEN_WIDTH/TETRIS_UNIT_WIDTH*TETRIS_SCREEN_HEIGHT/TETRIS_UNIT_HEIGHT)//72

#define TETRIS_COL_NUMS (TETRIS_SCREEN_WIDTH/TETRIS_UNIT_WIDTH)//6
#define TETRIS_ROW_NUMS (TETRIS_SCREEN_HEIGHT/TETRIS_UNIT_HEIGHT)//12

#define TETRIS_FREQUENCY_MAX 32
#define TETRIS_FREQUENCY_MIN 1

#define TETRIS_DELAY_TIME 100


using namespace std<span class="comment">;</span>

struct ImageRec {
    unsigned long sizeX<span class="comment">;</span>
    unsigned long sizeY<span class="comment">;</span>
    char *data<span class="comment">;</span>
}<span class="comment">;</span>

typedef struct _unitData{
    GLubyte angle:2,color:2,fill:2,stat:2<span class="comment">;</span>
}unitData<span class="comment">;</span>

typedef struct{
    GLshort col,row<span class="comment">;</span>
}unitPos<span class="comment">;</span>

typedef struct
{
    GLint mainWindow<span class="comment">; //which windown</span>
    GLint textureCount<span class="comment">; //number of texture the game use</span>
    GLuint theTextures[TETRIS_TEXTURE_COUNT+1]<span class="comment">; //to save information about texture</span>
    unitData units[TETRIS_UNITS_NUM+TETRIS_COL_NUMS*2]<span class="comment">; // 72+12 = 84</span>
    unitData CurUnits[2]<span class="comment">;</span>
    unitPos CurUnitsPos[2]<span class="comment">;</span>
    GLint CurUnitsStat<span class="comment">;</span>
    GLint frequency<span class="comment">; //if frequency be changed,the downing speed of object also be changed.</span>
    GLint frequencymax<span class="comment">; </span>
    GLint score<span class="comment">; //score</span>
    GLint scoreLastLevel<span class="comment">; //score when you pass the last level</span>
    GLint level<span class="comment">; //level</span>
    GLint gamecount<span class="comment">; //counter</span>
    GLboolean gameover<span class="comment">;    // equal to 0: the game is running, equal to 1: game will finish</span>
    GLboolean gamepause<span class="comment">; //tag about pausing the game</span>
    GLboolean updating<span class="comment">;        //</span>
    list&lt;unitData*&gt; pool<span class="comment">;</span>
    list&lt;unitData*&gt; poolex<span class="comment">;</span>
    GLint fontBase<span class="comment">;</span>
    GLboolean levelStart<span class="comment">; </span>
    GLint delay<span class="comment">; // to delay time </span>
    GLint updateLevel<span class="comment">; // </span>
    GLint waitUserTextSy,waitUserTextSydir<span class="comment">;</span>
}tetrisMainData<span class="comment">;</span>


#endif


#源文件#
#include "tetris.h"

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

using namespace std<span class="comment">;</span>
const char *appName="Tetris"<span class="comment">;</span>
const char *texturefiles[]={
"puyo_blue.png",
"puyo_green.png",
"puyo_red.png",
"puyo_yellow.png",
}<span class="comment">;</span>
const GLint TexCoord[4][4][2]={
    <span class="number">0.0,0.0</span>, <span class="number">1.0,0.0</span>, <span class="number">1.0,1.0</span>, <span class="number">0.0,1.0</span>,
        <span class="number">0.0,1.0</span>, <span class="number">0.0,0.0</span>, <span class="number">1.0,0.0</span>, <span class="number">1.0,1.0</span>,
        <span class="number">1.0,1.0</span>, <span class="number">0.0,1.0</span>, <span class="number">0.0,0.0</span>, <span class="number">1.0,0.0</span>,
        <span class="number">1.0,0.0</span>, <span class="number">1.0,1.0</span>, <span class="number">0.0,1.0</span>, <span class="number">0.0,0.0</span>,
}<span class="comment">;</span>

tetrisMainData tetris<span class="comment">;</span>

GLvoid Tetris_InitParam(void)<span class="comment">;</span>


#ifdef _TETRIS_DEBUG

GLvoid tetris_debug(GLint t)
{
    switch(t)
    {
    case 0:
        break<span class="comment">;</span>
    case 1:
        break<span class="comment">;</span>
    case 2:
        break<span class="comment">;</span>
    }
}


#define debugSeg1() \
if(tetris.CurUnitsPos[0].col == tetris.CurUnitsPos[1].col\
   &amp;&amp; tetris.CurUnitsPos[0].row == tetris.CurUnitsPos[1].row)\
   tetris_debug(1)<span class="comment">;</span>

#define debugSeg2()\
if(tetris.CurUnitsPos[0].row &gt; TETRIS_ROW_NUMS+1\
   || tetris.CurUnitsPos[0].row &lt; 0) tetris_debug(2)<span class="comment">;\</span>
if(tetris.CurUnitsPos[0].col &gt; TETRIS_COL_NUMS - 1\
   || tetris.CurUnitsPos[0].col &lt; 0) tetris_debug(2)<span class="comment">;\</span>
if(tetris.CurUnitsPos[1].row &gt; TETRIS_ROW_NUMS+1\
   || tetris.CurUnitsPos[1].row &lt; 0) tetris_debug(2)<span class="comment">;\</span>
if(tetris.CurUnitsPos[1].col &gt; TETRIS_COL_NUMS - 1\
   || tetris.CurUnitsPos[1].col &lt; 0) tetris_debug(2)<span class="comment">;\</span>

#define debugSeg3()\
if(fabs(tetris.CurUnitsPos[0].col - tetris.CurUnitsPos[1].col) &gt; 2 \
|| fabs(tetris.CurUnitsPos[0].row - tetris.CurUnitsPos[1].row) &gt; 2)\
        tetris_debug(3)<span class="comment">;</span>

#endif


//Read bitmap file data.
GLint ReadBMP(const char *filename, ImageRec *image) {

    FILE *file<span class="comment">;</span>
    unsigned long size<span class="comment">;</span>
    unsigned long i<span class="comment">;</span>
    unsigned short int planes<span class="comment">;</span>
    unsigned short int bpp<span class="comment">;</span>
    char temp<span class="comment">;</span>



    if ((file = fopen(filename, "rb"))==NULL) {
        printf("File Not Found : %s\n",filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    fseek(file, 18, SEEK_CUR)<span class="comment">;</span>

    if ((i = fread(&amp;image-&gt;sizeX, 4, 1, file)) != 1) {
        printf("Error reading width from %s.\n", filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    if ((i = fread(&amp;image-&gt;sizeY, 4, 1, file)) != 1) {
        printf("Error reading height from %s.\n", filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    size = image-&gt;sizeX * image-&gt;sizeY * 3<span class="comment">;</span>

    if ((fread(&amp;planes, 2, 1, file)) != 1) {
        printf("Error reading planes from %s.\n", filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    if (planes != 1) {
        printf("Planes from %s is not 1: %u\n", filename, planes)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    if ((i = fread(&amp;bpp, 2, 1, file)) != 1) {
        printf("Error reading bpp from %s.\n", filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    if (bpp != 24) {
        printf("Bpp from %s is not 24: %u\n", filename, bpp)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    fseek(file, 24, SEEK_CUR)<span class="comment">;</span>

    image-&gt;data = (char *) malloc(size)<span class="comment">;</span>
    if (image-&gt;data == NULL) {
        printf("Error allocating memory for color-corrected image data")<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    if ((i = fread(image-&gt;data, size, 1, file)) != 1) {
        printf("Error reading image data from %s.\n", filename)<span class="comment">;</span>
        return 0<span class="comment">;</span>
    }

    for (i=0<span class="comment">;i&lt;size;i+=3) {</span>
        temp = image-&gt;data[i]<span class="comment">;</span>
        image-&gt;data[i] = image-&gt;data[i+2]<span class="comment">;</span>
        image-&gt;data[i+2] = temp<span class="comment">;</span>
    }

    return 1<span class="comment">;</span>
}


//Load texture of font which the game used.
GLboolean LoadBmpTextures(char *file,GLuint *texture)                                  
{
    int Status=0<span class="comment">;                              </span>
    ImageRec *TextureImage=NULL<span class="comment">; </span>

    TextureImage = (ImageRec*)malloc(sizeof(ImageRec))<span class="comment">;</span>
    memset(TextureImage,0,sizeof(ImageRec))<span class="comment">;</span>

    if (ReadBMP(file,TextureImage))
    {
        Status=1<span class="comment">;                           </span>
        glGenTextures(1, texture)<span class="comment">;             </span>
        glBindTexture(GL_TEXTURE_2D, *texture)<span class="comment">;</span>
        glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR)<span class="comment">;</span>
        glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_LINEAR)<span class="comment">;</span>
        glTexImage2D(GL_TEXTURE_2D, 0, 3, TextureImage-&gt;sizeX, TextureImage-&gt;sizeY, 0, GL_RGB, GL_UNSIGNED_BYTE, TextureImage-&gt;data)<span class="comment">;</span>

    }

    if (TextureImage)                            
    {
        if (TextureImage-&gt;data)            
        {
            free(TextureImage-&gt;data)<span class="comment">;    </span>
        }    
        free(TextureImage)<span class="comment">;</span>
    }

    return Status<span class="comment">;                                 </span>
}


//Create font display list.
GLvoid BuildFont(GLuint *texture)                                
{
    float    cx<span class="comment">;                                    </span>
    float    cy<span class="comment">;        </span>
    tetris.fontBase=glGenLists(256)<span class="comment">;                                </span>
    glBindTexture(GL_TEXTURE_2D, (*texture))<span class="comment">;            </span>
    for (GLint loop=0<span class="comment">; loop&lt;256; loop++)                        </span>
    {
        cx=float(loop%16)/16.0f<span class="comment">;                        </span>
        cy=float(loop/16)/16.0f<span class="comment">;                        </span>

        glNewList(tetris.fontBase+loop,GL_COMPILE)<span class="comment">;            </span>
        glBegin(GL_QUADS)<span class="comment">;                            </span>
        glTexCoord2f(cx,1-cy-0.0625f)<span class="comment">;        </span>
        glVertex2i(0,0)<span class="comment">;                        </span>
        glTexCoord2f(cx+0.0625f,1-cy-0.0625f)<span class="comment">;    </span>
        glVertex2i(32,0)<span class="comment">;                        </span>
        glTexCoord2f(cx+0.0625f,1-cy)<span class="comment">;            </span>
        glVertex2i(32,32)<span class="comment">;                    </span>
        glTexCoord2f(cx,1-cy)<span class="comment">;                    </span>
        glVertex2i(0,32)<span class="comment">;                        </span>
        glEnd()<span class="comment">;                                </span>
        glTranslated(20,0,0)<span class="comment">;                        </span>
        glEndList()<span class="comment">;                                    </span>
    }                                                
}


//Delete the font
GLvoid KillFont(GLvoid)                                    
{
    glDeleteLists(tetris.fontBase,256)<span class="comment">;                            </span>
}


//We can call the function below to display the content you want to...
GLvoid glPrint(GLint x, GLint y, char *string)    
{
    glBindTexture(GL_TEXTURE_2D, tetris.theTextures[TETRIS_TEXTURE_COUNT])<span class="comment">;                                </span>
    glPushMatrix()<span class="comment">;                                        </span>
    glTranslated(x,y,0)<span class="comment">;                                </span>
    glListBase(tetris.fontBase)<span class="comment">;                        </span>
    glCallLists(strlen(string),GL_UNSIGNED_BYTE,string)<span class="comment">;                    </span>
    glPopMatrix()<span class="comment">;                        </span>
}

//
void Texture_Adjust(GLubyte r, GLubyte g, GLubyte b, GLubyte absolute)
{ 
    GLint width, height<span class="comment">; GLubyte* pixels = 0; </span>

    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_WIDTH, &amp;width)<span class="comment">;</span>
    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_HEIGHT, &amp;height)<span class="comment">; </span>

    pixels = (GLubyte*)malloc(width*height*4)<span class="comment">; </span>

    if( pixels == 0 ) return<span class="comment">; </span>

    glGetTexImage(GL_TEXTURE_2D, 0, GL_BGRA_EXT, GL_UNSIGNED_BYTE, pixels)<span class="comment">;     </span>
    { 
        GLint i<span class="comment">;</span>
        GLint count = width * height<span class="comment">; </span>
        for(i=0<span class="comment">; i&lt;count; ++i) </span>
        { 
            if( abs(pixels[i*4] - b) &lt;= absolute
                &amp;&amp; abs(pixels[i*4+1] - g) &lt;= absolute 
                &amp;&amp; abs(pixels[i*4+2] - r) &lt;= absolute ) 
                pixels[i*4+3] = 0<span class="comment">;</span>
            else 
                pixels[i*4+3] = 255<span class="comment">; </span>
        } 
    } 

    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_BGRA_EXT, GL_UNSIGNED_BYTE, pixels)<span class="comment">; </span>
    free(pixels)<span class="comment">;</span>
}

//
void Texture_SetAlpha(GLubyte r, GLubyte g, GLubyte b,GLubyte absolute,GLubyte alpha)
{ 
    GLint width, height<span class="comment">; GLubyte* pixels = 0; </span>

    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_WIDTH, &amp;width)<span class="comment">;</span>
    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_HEIGHT, &amp;height)<span class="comment">; </span>

    pixels = (GLubyte*)malloc(width*height*4)<span class="comment">; </span>

    if( pixels == 0 ) return<span class="comment">; </span>

    glGetTexImage(GL_TEXTURE_2D, 0, GL_BGRA_EXT, GL_UNSIGNED_BYTE, pixels)<span class="comment">;     </span>
    { 
        GLint i<span class="comment">;</span>
        GLint count = width * height<span class="comment">; </span>
        for(i=0<span class="comment">; i&lt;count; ++i){</span>

            if( abs(pixels[i*4] - b) &lt;= absolute
                &amp;&amp; abs(pixels[i*4+1] - g) &lt;= absolute 
                &amp;&amp; abs(pixels[i*4+2] - r) &lt;= absolute ) 
                pixels[i*4+3] = alpha<span class="comment">;        </span>
        }        
    } 

    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_BGRA_EXT, GL_UNSIGNED_BYTE, pixels)<span class="comment">; </span>
    free(pixels)<span class="comment">;</span>
}


//If the size of screen is changed,the function will be called.
//to readjust the screen param.
GLvoid changeWindow(GLsizei w, GLsizei h)
{
    if (h == 0) h = 1<span class="comment">;</span>
    glViewport(0, 0, w, h)<span class="comment">;</span>
    glMatrixMode(GL_PROJECTION)<span class="comment">;</span>
    glLoadIdentity()<span class="comment">;</span>
    if (w &lt;= h){
        gluOrtho2D(0.0, TETRIS_SCREEN_WIDTH, 0.0, TETRIS_SCREEN_WIDTH * (GLfloat) h/(GLfloat) w)<span class="comment">;</span>
        glScalef(1.0,((float)h/TETRIS_SCREEN_HEIGHT)/((float)w/TETRIS_SCREEN_WIDTH),1.0)<span class="comment">;</span>

    }
    else{
        gluOrtho2D(0.0, TETRIS_SCREEN_HEIGHT * (GLfloat) w/(GLfloat) h, 0.0, TETRIS_SCREEN_HEIGHT)<span class="comment">;</span>

        glScalef(((float)w/TETRIS_SCREEN_WIDTH)/((float)h/TETRIS_SCREEN_HEIGHT),<span class="number">1.0,1.0</span>)<span class="comment">;</span>
    }    
    glMatrixMode(GL_MODELVIEW)<span class="comment">;</span>
    glLoadIdentity()<span class="comment">;    </span>
}

//load all resource will be used.
GLvoid LoadGLTextures()
{
    glPixelStorei(GL_UNPACK_ALIGNMENT, 1)<span class="comment">;    </span>
    pngInfo info[4]<span class="comment">;</span>
    for (int k=0<span class="comment">; k &lt; TETRIS_TEXTURE_COUNT; k++){</span>
        glGenTextures(1,&amp;tetris.theTextures[k])<span class="comment">;</span>
        tetris.theTextures[k] = pngBind(texturefiles[k], PNG_NOMIPMAP, PNG_ALPHA, &amp;info[k], GL_CLAMP, GL_NEAREST, GL_NEAREST)<span class="comment">;</span>
        Texture_Adjust(<span class="number">255,255,255,10</span>)<span class="comment">;</span>
    }
    LoadBmpTextures("buchstabenalpha.bmp",&amp;tetris.theTextures[TETRIS_TEXTURE_COUNT])<span class="comment">;</span>
    Texture_Adjust(<span class="number">0,0,0,11</span>)<span class="comment">;</span>
    Texture_SetAlpha(<span class="number">133,133,133,122</span>,128)<span class="comment">;    </span>
    BuildFont(&amp;tetris.theTextures[TETRIS_TEXTURE_COUNT])<span class="comment">;        </span>
}


//Draw a sprites
GLvoid render2Dsprite(GLint x,GLint y,GLint w,GLint h,GLint textureId,GLint angle=0)
{        
    const GLint (*p)[2]=TexCoord[angle]<span class="comment">;</span>
    glBindTexture(GL_TEXTURE_2D,textureId)<span class="comment">;</span>
    glBegin (GL_POLYGON)<span class="comment">;</span>
    glTexCoord2f(p[0][0], p[0][1])<span class="comment">;    </span>
    glVertex2f (x, y)<span class="comment">;</span>
    glTexCoord2f(p[1][0], p[1][1])<span class="comment">;</span>
    glVertex2f (x+w, y)<span class="comment">;</span>
    glTexCoord2f(p[2][0], p[2][1])<span class="comment">;</span>
    glVertex2f (x+w, y+h)<span class="comment">;</span>
    glTexCoord2f(p[3][0], p[3][1])<span class="comment">;</span>
    glVertex2f (x, y+h)<span class="comment">;</span>
    glEnd ()<span class="comment">;    </span>
}


//Draw the scene of the game.
GLvoid render()
{
    glutSetWindow(tetris.mainWindow)<span class="comment">;</span>
    glClearColor(0.0, 0.0, 0.0, 1.0)<span class="comment">;</span>
    glClear (GL_COLOR_BUFFER_BIT)<span class="comment">;</span>
    glLoadIdentity()<span class="comment">;</span>
    glPushMatrix()<span class="comment">;</span>

    char str[32]<span class="comment">;</span>

    glPushMatrix()<span class="comment">;</span>
    glEnable (GL_BLEND)<span class="comment">;</span>

        glLoadIdentity()<span class="comment">;</span>
        str[0] = '\0'<span class="comment">;</span>
        strcpy(str,"Tetris")<span class="comment">;</span>
        glTranslatef(0.0,TETRIS_SCREEN_HEIGHT/2,0.0)<span class="comment">;</span>
        glScalef(<span class="number">3.2,3.2</span>,1.0)<span class="comment">;        </span>
        glPrint(<span class="number">0.0,0.0</span>,str)<span class="comment">;</span>
        glDisable(GL_BLEND)<span class="comment">;        </span>
    glPopMatrix()<span class="comment">;    </span>
    glPushMatrix()<span class="comment">;    </span>

        if(tetris.gameover){
            if(tetris.gamecount&gt;&gt;4&amp;1){
            glTranslatef(30,TETRIS_SCREEN_HEIGHT/<span class="number">2.0,0.0</span>)<span class="comment">;            </span>
            glScalef(<span class="number">1.5,1.5</span>,1.0)<span class="comment">;        </span>
            glPrint(<span class="number">0.0,0.0</span>,"Game Over!")<span class="comment">;    </span>
            }
        }

        if(tetris.levelStart==1){
            if(tetris.gamecount&gt;&gt;4&amp;1){
                glTranslatef(50,TETRIS_SCREEN_HEIGHT/<span class="number">2.0,0.0</span>)<span class="comment">;</span>
                str[0] = '\0'<span class="comment">;</span>
                sprintf(str,"Level %d",tetris.level)<span class="comment">;</span>
                glScalef(<span class="number">2.0,2.0</span>,1.0)<span class="comment">;        </span>
                glPrint(<span class="number">0.0,0.0</span>,str)<span class="comment">;</span>
            }
        }

        if(tetris.levelStart == 2)
        {

            if(tetris.gamecount&gt;&gt;4&amp;1){
                glTranslatef(20.0,TETRIS_SCREEN_HEIGHT/2.0+tetris.waitUserTextSy,0.0)<span class="comment">;    </span>
                glScalef(<span class="number">0.8,0.8</span>,1.0)<span class="comment">;</span>
                glPrint(<span class="number">0.0,0.0</span>,"Press Enter to replay.")<span class="comment">;</span>
            }

            if(tetris.waitUserTextSydir){
                tetris.waitUserTextSy += 2<span class="comment">;</span>
                if(tetris.waitUserTextSy &gt; TETRIS_SCREEN_HEIGHT/2 - 32)
                    tetris.waitUserTextSydir = 0<span class="comment">;</span>
            }else{
                tetris.waitUserTextSy -= 2<span class="comment">;</span>
                if(tetris.waitUserTextSy &lt; -(TETRIS_SCREEN_HEIGHT/2 - 32))
                    tetris.waitUserTextSydir = 1<span class="comment">;</span>
            }            
        }

        if(tetris.updateLevel)
        {
            tetris.updateLevel--<span class="comment">;</span>
            if(tetris.updateLevel&gt;TETRIS_DELAY_TIME){
                if(tetris.gamecount&gt;&gt;4&amp;1){
                    glTranslatef(35.0,TETRIS_SCREEN_HEIGHT/<span class="number">2.0,0.0</span>)<span class="comment">;    </span>
                    glScalef(<span class="number">0.8,0.8</span>,1.0)<span class="comment">;</span>
                    glPrint(<span class="number">0.0,0.0</span>,"Congratulation!")<span class="comment">;</span>
                    glTranslatef(-15.0,-<span class="number">20.0,0.0</span>)<span class="comment">;</span>
                    glPrint(<span class="number">0.0,0.0</span>,"Level updating!")<span class="comment">;</span>
                }
            }else{
                if(tetris.gamecount&gt;&gt;4&amp;1){
                    glTranslatef(50,TETRIS_SCREEN_HEIGHT/<span class="number">2.0,0.0</span>)<span class="comment">;</span>
                    str[0] = '\0'<span class="comment">;</span>
                    sprintf(str,"Level %d",tetris.level)<span class="comment">;</span>
                    glScalef(<span class="number">2.0,2.0</span>,1.0)<span class="comment">;        </span>
                    glPrint(<span class="number">0.0,0.0</span>,str)<span class="comment">;</span>
                }
            }
        }
        glPopMatrix()<span class="comment">;</span>

    unitData *p=tetris.units,*pTemp<span class="comment">;</span>
    for(int j=0<span class="comment">;j&lt;TETRIS_ROW_NUMS;j++){    </span>
        for(int i=0<span class="comment">;i&lt;TETRIS_COL_NUMS;i++){</span>
            pTemp = &amp;p[j*TETRIS_COL_NUMS+i]<span class="comment">;</span>
            if(pTemp-&gt;fill){                
                glPushMatrix()<span class="comment">;                </span>
                render2Dsprite(i*TETRIS_UNIT_WIDTH,j*TETRIS_UNIT_HEIGHT,TETRIS_UNIT_WIDTH,TETRIS_UNIT_HEIGHT,tetris.theTextures[pTemp-&gt;color],pTemp-&gt;angle)<span class="comment">; </span>
                glPopMatrix()<span class="comment">;            </span>
            }
        }    
    }

    glPushMatrix()<span class="comment">;    </span>
        glEnable (GL_BLEND)<span class="comment">;</span>
        glDisable(GL_ALPHA_TEST)<span class="comment">; </span>
        glLoadIdentity()<span class="comment">;</span>
        glTranslatef(0.0,TETRIS_SCREEN_HEIGHT-32,0.0)<span class="comment">;                    </span>
        glPushMatrix()<span class="comment">;</span>
            str[0] = '\0'<span class="comment">;</span>
            glScalef(<span class="number">0.8,0.8</span>,1.0)<span class="comment">;</span>
            sprintf(str,"Score:%d",tetris.score)<span class="comment">;</span>
            glPrint(<span class="number">0.0,0.0</span>,str)<span class="comment">;</span>
        glPopMatrix()<span class="comment">;    </span>
        glTranslatef(TETRIS_SCREEN_WIDTH*<span class="number">2/3,0.0</span>,0.0)<span class="comment">;</span>
        glPushMatrix()<span class="comment">;</span>
            str[0] = '\0'<span class="comment">;</span>
            glScalef(<span class="number">0.8,0.8</span>,1.0)<span class="comment">;</span>
            sprintf(str,"Level:%d",tetris.level)<span class="comment">;</span>
            glPrint(<span class="number">0.0,0.0</span>,str)<span class="comment">;</span>
        glPopMatrix()<span class="comment">;</span>

        glTranslatef(-TETRIS_SCREEN_WIDTH*2/3,-<span class="number">20.0,0.0</span>)<span class="comment">;</span>
        glPushMatrix()<span class="comment">;            </span>
        glScalef(<span class="number">0.7,0.7</span>,1.0)<span class="comment">;        </span>
        glPrint(<span class="number">0.0,0.0</span>,"Press Space to pause.")<span class="comment">;</span>
        glTranslatef(0.0,-<span class="number">20.0,0.0</span>)<span class="comment">;</span>
        glPrint(<span class="number">0.0,0.0</span>,"Press Esc to exit.")<span class="comment">;</span>
        glPopMatrix()<span class="comment">;</span>

        glDisable(GL_BLEND)<span class="comment">;</span>
        glEnable (GL_ALPHA_TEST)<span class="comment">;</span>
    glPopMatrix()<span class="comment">;    </span>

    glEnd ()<span class="comment">;</span>
    glPopMatrix()<span class="comment">;    </span>
    glutSwapBuffers()<span class="comment">;    </span>
}

GLvoid Tetris_SetSingleUnit(unitData *p,GLint color,GLint angle)
{
    p-&gt;fill = 1<span class="comment">; p-&gt;color = color; p-&gt;angle = angle;</span>
}


//Rotate the object.
GLvoid Tetris_TwoUnitRotate()
{
    if(tetris.CurUnitsStat != 1) return<span class="comment">;</span>

    unitData *pDest=NULL,*pMid=NULL,*pTemp<span class="comment">;</span>
    unitData (*pa)[TETRIS_COL_NUMS]=(unitData (*)[TETRIS_COL_NUMS])tetris.units<span class="comment">;</span>

    pTemp = &amp;pa[tetris.CurUnitsPos[0].row][tetris.CurUnitsPos[0].col]<span class="comment">;</span>

    if(tetris.CurUnitsPos[1].col == tetris.CurUnitsPos[0].col){        
        if(tetris.CurUnitsPos[1].row &lt; tetris.CurUnitsPos[0].row){
            if(tetris.CurUnitsPos[1].col == TETRIS_COL_NUMS - 1) return<span class="comment">;</span>
            pMid = pTemp - TETRIS_COL_NUMS + 1<span class="comment">;</span>
            pDest = pTemp + 1<span class="comment">;</span>
        }else if(tetris.CurUnitsPos[1].row &gt; tetris.CurUnitsPos[0].row){
            if(tetris.CurUnitsPos[1].col == 0) return<span class="comment">;</span>
            pMid = pTemp + TETRIS_COL_NUMS - 1<span class="comment">;</span>
            pDest = pTemp - 1<span class="comment">;</span>
        }else{
#ifdef _TETRIS_DEBUG
            tetris_debug(0)<span class="comment">;</span>
#endif
        }
    }else if(tetris.CurUnitsPos[1].row == tetris.CurUnitsPos[0].row){
        if(tetris.CurUnitsPos[1].col &lt; tetris.CurUnitsPos[0].col){
            if(tetris.CurUnitsPos[1].row == 0) return<span class="comment">;</span>
            pMid = pTemp - TETRIS_COL_NUMS - 1<span class="comment">;</span>
            pDest = pTemp - TETRIS_COL_NUMS<span class="comment">;</span>
        }else if(tetris.CurUnitsPos[1].col &gt; tetris.CurUnitsPos[0].col){
            pMid = pTemp + TETRIS_COL_NUMS + 1<span class="comment">;</span>
            pDest = pTemp + TETRIS_COL_NUMS<span class="comment">;</span>
        }else{
#ifdef _TETRIS_DEBUG
            tetris_debug(0)<span class="comment">;</span>
#endif
        }        
    }else {
#ifdef _TETRIS_DEBUG
        tetris_debug(0)<span class="comment">;</span>
#endif
    }

    if(NULL == pDest || NULL == pMid) return<span class="comment">;</span>

    if(pDest-&gt;fill || pMid-&gt;fill) return<span class="comment">;</span>

    pa[tetris.CurUnitsPos[1].row][tetris.CurUnitsPos[1].col].fill = 0<span class="comment">;    </span>

    tetris.CurUnitsPos[1].col = (pDest - tetris.units) % TETRIS_COL_NUMS<span class="comment">;</span>
    tetris.CurUnitsPos[1].row = (pDest - tetris.units) / TETRIS_COL_NUMS<span class="comment">;</span>

    tetris.CurUnits[1].angle = (tetris.CurUnits[1].angle+1)%4<span class="comment">;</span>
    tetris.CurUnits[0].angle = (tetris.CurUnits[0].angle+1)%4<span class="comment">;</span>

    pa[tetris.CurUnitsPos[0].row][tetris.CurUnitsPos[0].col].angle = tetris.CurUnits[0].angle<span class="comment">;</span>

    Tetris_SetSingleUnit(pDest,tetris.CurUnits[1].color,tetris.CurUnits[1].angle)<span class="comment">;</span>

}


//Call back function about keyboard.
GLvoid keys(unsigned char key, GLint x, GLint y)
{
    if(key == TETRIS_KEY_ESCAPE) exit(0)<span class="comment">;</span>

    if(key == TETRIS_KEY_SPACE) { tetris.gamepause = (++tetris.gamepause)%2<span class="comment">;}</span>

    if(key == TETRIS_KEY_ENTER) {
        tetris.levelStart = 0<span class="comment">;</span>
        tetris.delay = TETRIS_DELAY_TIME<span class="comment">;</span>
        Tetris_InitParam()<span class="comment">;</span>

    }

    if(tetris.CurUnitsStat != 1) return<span class="comment">;</span>
    if(tetris.gamepause) return<span class="comment">;</span>
    if(tetris.levelStart) return<span class="comment">;</span>
    if(tetris.gameover) return<span class="comment">;</span>

    unitData (*pa)[TETRIS_COL_NUMS]=(unitData (*)[TETRIS_COL_NUMS])tetris.units<span class="comment">;</span>
    unitData *pUnitTemp[2]<span class="comment">;</span>

    GLint i,j,k<span class="comment">;</span>

    for(i=0<span class="comment">;i&lt;2;i++)</span>
        pUnitTemp[i] = &amp;pa[tetris.CurUnitsPos[i].row][tetris.CurUnitsPos[i].col]<span class="comment">;</span>

    switch(key)
    {
    case TETRIS_KEY_SPACE:        
        break<span class="comment">;</span>
    case TETRIS_KEY_UP:
        Tetris_TwoUnitRotate()<span class="comment">;</span>
        break<span class="comment">;</span>
    case TETRIS_KEY_DOWN:        
        tetris.frequency = TETRIS_FREQUENCY_MIN<span class="comment">;</span>
        break<span class="comment">;</span>
    case TETRIS_KEY_LEFT:
        j = tetris.CurUnitsPos[0].col &lt;= tetris.CurUnitsPos[1].col<span class="comment">;</span>
        for(k=0<span class="comment">;k&lt;2;k++){</span>
            if(j == 0) i = (k+1)%2<span class="comment">;</span>
            else i = k<span class="comment">;        </span>
            if(tetris.CurUnits[i].stat) continue<span class="comment">;</span>
            if(tetris.CurUnitsPos[i].col &gt; 0
                &amp;&amp; !(pUnitTemp[i]-1)-&gt;fill){
                tetris.CurUnitsPos[i].col--<span class="comment">;</span>
                pUnitTemp[i]-&gt;fill = 0<span class="comment">;                 </span>
                Tetris_SetSingleUnit(pUnitTemp[i]-1,tetris.CurUnits[i].color,tetris.CurUnits[i].angle)<span class="comment">;    </span>
            }
        }
        break<span class="comment">;</span>
    case TETRIS_KEY_RIGHT:
        j = tetris.CurUnitsPos[0].col &gt;= tetris.CurUnitsPos[1].col<span class="comment">;</span>
        for(k=0<span class="comment">;k&lt;2;k++){            </span>
            if(j == 0) i = (k+1)%2<span class="comment">;</span>
            else i = k<span class="comment">;</span>
            if(tetris.CurUnits[i].stat) continue<span class="comment">;</span>
            if(tetris.CurUnitsPos[i].col &lt; TETRIS_COL_NUMS - 1
                &amp;&amp; !(pUnitTemp[i]+1)-&gt;fill){    
                tetris.CurUnitsPos[i].col++<span class="comment">;</span>
                pUnitTemp[i]-&gt;fill = 0<span class="comment">;</span>
                Tetris_SetSingleUnit(pUnitTemp[i]+1,tetris.CurUnits[i].color,tetris.CurUnits[i].angle)<span class="comment">;</span>
            }
        }
        break<span class="comment">;</span>
    }
    glutPostRedisplay()<span class="comment">;</span>
}



GLvoid specialKeysPressed(GLint key, GLint x, GLint y)
{
    switch(key)
    {
    case GLUT_KEY_UP:
        keys(TETRIS_KEY_UP,0,0)<span class="comment">;</span>
        break<span class="comment">;</span>
    case GLUT_KEY_DOWN:
        keys(TETRIS_KEY_DOWN,0,0)<span class="comment">;        </span>
        break<span class="comment">;</span>
    case GLUT_KEY_LEFT:
        keys(TETRIS_KEY_LEFT,0,0)<span class="comment">;</span>
        break<span class="comment">;</span>
    case GLUT_KEY_RIGHT:
        keys(TETRIS_KEY_RIGHT,0,0)<span class="comment">;         </span>
        break<span class="comment">;</span>
    }    
}

GLvoid Tetris_InitMem(void*start,GLint size)
{
    GLbyte *p=(GLbyte*)start<span class="comment">;</span>
    while(size--) (*p) = 0<span class="comment">;</span>
}

GLvoid Tetris_InitTwoUnits(unitData*p)
{
    GLint tmp=rand()%3<span class="comment">;</span>

    switch(tmp)
    {
    case 0:
        tmp = TETRIS_COL_NUMS / 2 - 1<span class="comment">;</span>
        tetris.CurUnitsPos[0].col = tmp<span class="comment">;</span>
        tetris.CurUnitsPos[1].col = tmp+1<span class="comment">;</span>
        tetris.CurUnitsPos[0].row = TETRIS_ROW_NUMS<span class="comment">;</span>
        tetris.CurUnitsPos[1].row = TETRIS_ROW_NUMS<span class="comment">;        </span>
        break<span class="comment">;</span>
    case 1:
        tmp = TETRIS_COL_NUMS / 2 - 1<span class="comment">;</span>
        tetris.CurUnitsPos[0].col = tmp<span class="comment">;</span>
        tetris.CurUnitsPos[1].col = tmp<span class="comment">;</span>
        tetris.CurUnitsPos[0].row = TETRIS_ROW_NUMS<span class="comment">;</span>
        tetris.CurUnitsPos[1].row = TETRIS_ROW_NUMS+1<span class="comment">;</span>
        break<span class="comment">;</span>
    case 2:
        tmp = TETRIS_COL_NUMS / 2<span class="comment">;</span>
        tetris.CurUnitsPos[0].col = tmp<span class="comment">;</span>
        tetris.CurUnitsPos[1].col = tmp<span class="comment">;</span>
        tetris.CurUnitsPos[0].row = TETRIS_ROW_NUMS<span class="comment">;</span>
        tetris.CurUnitsPos[1].row = TETRIS_ROW_NUMS+1<span class="comment">;</span>
        break<span class="comment">;</span>
    }

    Tetris_InitMem(&amp;p[0],sizeof(unitData))<span class="comment">;</span>
    p[0].color = rand()%4<span class="comment">;</span>
    Tetris_InitMem(&amp;p[1],sizeof(unitData))<span class="comment">;</span>
    p[1].color = rand()%4<span class="comment">;</span>
    tetris.CurUnitsStat = 1<span class="comment">;</span>
}

GLvoid Tetris_GameOver()
{
    memset(tetris.units,0,sizeof(tetris.units))<span class="comment">;</span>
    tetris.pool.clear()<span class="comment">;</span>
    tetris.poolex.clear()<span class="comment">;</span>
}


//
GLboolean Tetris_TwoUnitsFunc(unitData *p)
{
    unitData (*pa)[TETRIS_COL_NUMS]=(unitData (*)[TETRIS_COL_NUMS])tetris.units<span class="comment">;</span>
    unitData *pUnitTemp[2],*ps<span class="comment">;</span>

    GLint i,j,k,cnt<span class="comment">;</span>

    for(i=0<span class="comment">;i&lt;2;i++)</span>
        pUnitTemp[i] = &amp;pa[tetris.CurUnitsPos[i].row][tetris.CurUnitsPos[i].col]<span class="comment">;    </span>

    if(tetris.gamecount % tetris.frequency){ return 0<span class="comment">;}</span>
    else{    
        j = (tetris.CurUnitsPos[0].row &lt;= tetris.CurUnitsPos[1].row)<span class="comment">;</span>
        cnt = 0<span class="comment">;</span>
        for(k=0<span class="comment">;k&lt;2;k++){</span>
            if(j == 0) i = (k+1)%2<span class="comment">;</span>
            else i = k<span class="comment">;</span>
            if(0 != p[i].stat) 
                continue<span class="comment">;</span>
            cnt++<span class="comment">;</span>
            ps = pUnitTemp[i] - TETRIS_COL_NUMS<span class="comment">;</span>
            if(ps &gt;= tetris.units){    
                if(ps-&gt;fill &lt; 2){
                    if(--tetris.CurUnitsPos[i].row &lt; 0) 
                        tetris.CurUnitsPos[i].row = 0<span class="comment">;                        </span>
                    Tetris_SetSingleUnit(ps,p[i].color,p[i].angle)<span class="comment">;                    </span>
                    pUnitTemp[i]-&gt;fill = 0<span class="comment">;                        </span>
                }else {
                    if(ps &lt; &amp;tetris.units[TETRIS_UNITS_NUM])
                    {
                        pUnitTemp[i]-&gt;fill = 2<span class="comment">;</span>
                        if(pUnitTemp[i] &gt; &amp;tetris.units[TETRIS_UNITS_NUM] - TETRIS_COL_NUMS )
                        {
                            tetris.gameover = 1<span class="comment">;</span>
                            tetris.delay = TETRIS_DELAY_TIME*2<span class="comment">;</span>
                            Tetris_GameOver()<span class="comment">;</span>
                            return 1<span class="comment">;</span>
                        }
                    }
                    p[i].stat = 1<span class="comment">;                </span>
                }
            }else{
                p[i].stat = 1<span class="comment">;                </span>
                pUnitTemp[i]-&gt;fill = 2<span class="comment">;                        </span>
            }
        }
        if(0 == cnt) tetris.CurUnitsStat = 2<span class="comment">;</span>

        tetris.updating = 1<span class="comment">;</span>
        tetris.pool.clear()<span class="comment">;</span>
        tetris.pool.push_back(&amp;pa[tetris.CurUnitsPos[0].row][tetris.CurUnitsPos[0].col])<span class="comment">;</span>
        tetris.pool.push_back(&amp;pa[tetris.CurUnitsPos[1].row][tetris.CurUnitsPos[1].col])<span class="comment">;</span>
    }
    return 1<span class="comment">;</span>
}



GLvoid Tetris_Update()
{
    GLint i,j,cnt=0<span class="comment">;</span>

    unitData (*pa)[TETRIS_COL_NUMS]=(unitData (*)[TETRIS_COL_NUMS])tetris.units<span class="comment">;</span>

    list&lt;unitData*&gt; *pool<span class="comment">;</span>
    list&lt;unitData*&gt;<span class="number">::</span>iterator iter<span class="comment">;    </span>

    GLint col,row<span class="comment">;</span>

    pool = &amp;tetris.poolex<span class="comment">;</span>

    for(cnt=0,iter=pool-&gt;begin()<span class="comment">;iter != pool-&gt;end(); iter++)</span>
    {
        unitData *p,*q<span class="comment">;</span>

        p = q = (*iter)<span class="comment">;</span>

        i = 0<span class="comment">;</span>
        p += TETRIS_COL_NUMS<span class="comment">;</span>
        while(p &lt; &amp;tetris.units[TETRIS_UNITS_NUM] &amp;&amp; p-&gt;fill) { i++<span class="comment">; p += TETRIS_COL_NUMS; }</span>

        if(i &gt; 0)
        {            
            p = (*iter)<span class="comment">;</span>
            p -= TETRIS_COL_NUMS<span class="comment">;</span>
            while(p &gt;= tetris.units &amp;&amp; !p-&gt;fill) {p -= TETRIS_COL_NUMS<span class="comment">; }    </span>

            tetris.pool.push_back(p+TETRIS_COL_NUMS)<span class="comment">;</span>

            j = 0<span class="comment">;</span>
            while(j++ &lt; i){
                p += TETRIS_COL_NUMS<span class="comment">;</span>
                q += TETRIS_COL_NUMS<span class="comment">; </span>
                (*p)=(*q)<span class="comment">;</span>
                p-&gt;fill = 2<span class="comment">;</span>
                q-&gt;fill = 0<span class="comment">;</span>
            }    

            cnt++<span class="comment">;</span>
        }        
    }

    if(pool-&gt;size() &gt; 0) pool-&gt;clear()<span class="comment">;</span>

    if(cnt) return<span class="comment">;</span>

    pool = &amp;tetris.pool<span class="comment">;</span>

    for(cnt = 0,iter=pool-&gt;begin()<span class="comment">;iter != pool-&gt;end(); iter++)</span>
    {
        unitData *p,*pthis<span class="comment">;</span>

        GLint nums[4]={0},num=0<span class="comment">; //bottom,left,right,above</span>
        GLint thiscol,thisrow,index<span class="comment">;</span>

        p = pthis = (*iter)<span class="comment">;</span>

        index = p - tetris.units<span class="comment">;</span>
        thiscol = index % TETRIS_COL_NUMS<span class="comment">;</span>
        thisrow = index / TETRIS_COL_NUMS<span class="comment">;</span>

        //bottom
        i = 0<span class="comment">;</span>
        row = thisrow - 1<span class="comment">;</span>
        col = thiscol<span class="comment">;</span>
        p = &amp;pa[row][col]<span class="comment">;</span>
        while(row &gt;= 0 &amp;&amp; p-&gt;fill &amp;&amp; p-&gt;color == pthis-&gt;color) { nums[0]++<span class="comment">; p = &amp;pa[--row][col]; }</span>

        //left
        i = 0<span class="comment">;</span>
        row = thisrow<span class="comment">;</span>
        col = thiscol - 1<span class="comment">;</span>
        p = &amp;pa[row][col]<span class="comment">;</span>
        while(col &gt;= 0 &amp;&amp; p-&gt;fill &amp;&amp; p-&gt;color == pthis-&gt;color) { nums[1]++<span class="comment">; p = &amp;pa[row][--col]; }</span>

        //right
        i = 0<span class="comment">;</span>
        row = thisrow<span class="comment">;</span>
        col = thiscol + 1<span class="comment">;</span>
        p = &amp;pa[row][col]<span class="comment">;</span>
        while(col &lt; TETRIS_COL_NUMS &amp;&amp; p-&gt;fill &amp;&amp; p-&gt;color == pthis-&gt;color) { nums[2]++<span class="comment">; p = &amp;pa[row][++col]; }</span>

        //above
        i = 0<span class="comment">;</span>
        row = thisrow + 1<span class="comment">;</span>
        col = thiscol<span class="comment">;</span>
        p = &amp;pa[row][col]<span class="comment">;</span>
        while(row &lt; TETRIS_ROW_NUMS &amp;&amp; p-&gt;fill &amp;&amp; p-&gt;color == pthis-&gt;color) { 
            nums[3]++<span class="comment">; p = &amp;pa[++row][col]; </span>
        }

        num = nums[0] + nums[3] + 1<span class="comment">;</span>
        if(num &gt;= 4){
            p = pthis - nums[0] * TETRIS_COL_NUMS<span class="comment">;</span>
            for(i = 0<span class="comment">; i &lt; num; i++){</span>
                p-&gt;fill = 0<span class="comment">;</span>
                p += TETRIS_COL_NUMS<span class="comment">;</span>
            }

            tetris.score += 5*num<span class="comment">;</span>

            p = p-TETRIS_COL_NUMS<span class="comment">;</span>

            unitPos *pos=tetris.CurUnitsPos<span class="comment">;</span>

            if(p == &amp;pa[pos[0].row][pos[0].col]
                || p == &amp;pa[pos[0].row][pos[0].col]){}
            else{                
                tetris.poolex.push_back(p)<span class="comment">;</span>
                cnt++<span class="comment">;</span>
            }
        }

        num = nums[1] + nums[2] + 1<span class="comment">;</span>
        if(num &gt;= 4){            
            p = pthis - nums[1]<span class="comment">;        </span>
            for(i = 0<span class="comment">; i &lt; num; i++){</span>
                tetris.poolex.push_back(p)<span class="comment">;</span>
                p-&gt;fill = 0<span class="comment">;                </span>
                p++<span class="comment">;</span>
            }    
            tetris.score += 5*num<span class="comment">;</span>
            cnt++<span class="comment">;</span>
        }
    }

    if((tetris.score - tetris.scoreLastLevel) &gt; 50 + (tetris.level) * 10){
        tetris.updateLevel = 128<span class="comment">;</span>
        tetris.level++<span class="comment">;</span>
        tetris.scoreLastLevel = tetris.score<span class="comment">;</span>
        tetris.frequencymax -= 2<span class="comment">;</span>
        if(tetris.frequencymax &lt; 1) tetris.frequencymax = 1<span class="comment">;</span>
    }

    if(0 == cnt) {
        tetris.updating = 0<span class="comment">;</span>
        for(i = 0<span class="comment">; i &lt; 2; i++)</span>
            if(!pa[tetris.CurUnitsPos[i].row][tetris.CurUnitsPos[i].col].fill) 
                tetris.CurUnits[i].stat = 1<span class="comment">;</span>
    }
    else tetris.updating++<span class="comment">;</span>

}


//Timer, 
GLvoid OnTimer(int time)
{
    unitData *p=tetris.CurUnits<span class="comment">;</span>

    GLboolean flag=0<span class="comment">;</span>

    if(++tetris.gamecount == 30000)
        tetris.gamecount = 0<span class="comment">;</span>

    if(tetris.gamepause
        ||tetris.gameover
        || tetris.levelStart
        || tetris.delay) 
    {
        glutTimerFunc(5, OnTimer, 1)<span class="comment">;        </span>
        glutPostRedisplay()<span class="comment">;</span>
        if(tetris.delay &gt; 0){
            tetris.delay--<span class="comment">;</span>
            if(tetris.delay == 0){
                if(tetris.levelStart==1){
                    tetris.levelStart = 0<span class="comment">;</span>
                    //tetris.gameover = 1<span class="comment">;</span>
                    //tetris.delay = TETRIS_DELAY_TIME<span class="comment">;</span>
                    //tetris.levelStart = 2<span class="comment">;</span>

                    return<span class="comment">;</span>
                }

                if(tetris.gameover){
                    tetris.gameover = 0<span class="comment">;</span>
                    tetris.levelStart = 2<span class="comment">;</span>
                    tetris.waitUserTextSy = 0<span class="comment">;</span>
                    return<span class="comment">;</span>
                }
            }
        }
        return<span class="comment">;</span>
    }

    switch(tetris.CurUnitsStat)
    {

    case 0:        
        Tetris_InitTwoUnits(p)<span class="comment">;</span>
        break<span class="comment">;</span>
    case 1:
        if(!tetris.updating)
            flag = Tetris_TwoUnitsFunc(p)<span class="comment">;</span>
        break<span class="comment">;</span>
    case 2:    
        tetris.CurUnitsStat = 0<span class="comment">;    </span>
        break<span class="comment">;</span>
    }

    glutPostRedisplay()<span class="comment">;    </span>
    glutTimerFunc(5, OnTimer, 1)<span class="comment">;</span>

    if(!flag &amp;&amp; tetris.updating)        
        Tetris_Update()<span class="comment">;    </span>
    tetris.frequency = tetris.frequencymax<span class="comment">;    </span>
}

GLvoid idle()
{

}

GLvoid Tetris_InitParam(void)
{
    tetris.level = 1<span class="comment">;</span>
    tetris.score = 0<span class="comment">;</span>
    tetris.levelStart = 1<span class="comment">;</span>
    tetris.frequencymax = TETRIS_FREQUENCY_MAX<span class="comment">;</span>
    tetris.frequency = tetris.frequencymax<span class="comment">;</span>
    tetris.delay = TETRIS_DELAY_TIME<span class="comment">;</span>
    tetris.CurUnitsStat = 0<span class="comment">;</span>
    memset(tetris.CurUnits,0,sizeof(tetris.CurUnits))<span class="comment">;</span>
    memset(tetris.CurUnitsPos,0,sizeof(tetris.CurUnitsPos))<span class="comment">;</span>
    memset(tetris.units,0,sizeof(tetris.units))<span class="comment">;</span>
    tetris.scoreLastLevel = 0<span class="comment">;</span>
}


//Init game.
GLvoid initgame()
{
    LoadGLTextures()<span class="comment">;    </span>
    glEnable(GL_TEXTURE_2D)<span class="comment">;</span>
    glAlphaFunc(GL_GREATER, 0.1f)<span class="comment">;    </span>
    glEnable (GL_BLEND)<span class="comment">;</span>
    glBlendFunc (GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA)<span class="comment">;</span>
    glShadeModel (GL_FLAT)<span class="comment">;    </span>
    Tetris_InitParam()<span class="comment">;    </span>
}

GLint main(GLint argc,char** argv)
{
    glutInit(&amp;argc, argv)<span class="comment">;</span>
    glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGBA)<span class="comment">;</span>
    glutInitWindowPosition(<span class="number">100,100</span>)<span class="comment">;</span>
    glutInitWindowSize(TETRIS_SCREEN_WIDTH,TETRIS_SCREEN_HEIGHT)<span class="comment">;    </span>
    tetris.mainWindow = glutCreateWindow(appName)<span class="comment">;    </span>
    glutReshapeFunc(changeWindow)<span class="comment">;</span>
    glutDisplayFunc(render)<span class="comment">;</span>
    glutKeyboardFunc(keys)<span class="comment">;</span>
    glutSpecialFunc(specialKeysPressed)<span class="comment">;</span>
    glutSetCursor(GLUT_CURSOR_NONE)<span class="comment">;</span>
    glutTimerFunc(5,OnTimer,1)<span class="comment">;</span>
    glutIdleFunc(idle)<span class="comment">;</span>

    initgame()<span class="comment">;</span>

    glutMainLoop()<span class="comment">;    </span>
    return 0<span class="comment">;</span>
}
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-16T05:39:04.000Z"><a href="/2014/03/16/about-overtime/">2014-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/16/about-overtime/">无休止的加班：游戏行业从业人员出路在何方？</a></h1>
  

    </header>
    <div class="entry">
      
        <p><strong>问题</strong>：</p>
<p>　　加班是互联网行业永远的痛，但普通的IT公司，产品起码有个间歇期，而在游戏行业，项目节点定下来后，为保证抢钱节奏，基本天昏地暗永无止境地加班，根本没有时间找女朋友。（本问题具有泛用性，请勿关闭我题目）</p>
<ul>
<li><p>工作状态：本人于某二线公司做端游策划2年了。基本一周内1次8点走，2次10点走，2次11点走的节奏，时不时来个通宵和周末加班。陪同赶进度的有程序、测试、合作方的运营团队等人。我认为我们是个成熟的团队，效率甚高，只是工作量之大是必然。</p>
</li>
<li><p>福利回馈。加班费当然是没有。工资就二线水平，在广州一般般。赚钱了得看老板脸色，去年居然只发半个月奖金。（好歹也是1000W/M的流水啊）</p>
</li>
<li><p>晋升途径。策划可升主策，程序可升主管，运营可升经理。但都是以有新开项目为前提，按照二线公司的尿性，找主管喜欢社招而不内部提升。个人认为跳槽到同为二线的公司谋求晋升是一条路，社招去企鹅、X易还是普通员工但待遇大幅提升也不错。</p>
</li>
<li><p>路在何方？问题重点是：人总要成家立业，但做游戏，工作几乎占据了全部，没时间泡妞和进行其余的爱好，有些有老婆的人还因此闹离婚的事也见不少，总而言之生活质量很低，除非到了制作人或总监的级别（游戏圈子真不大，进进出出，最后转业的人很多）。究竟如何才能提高生活质量，路在何方？创业？呵呵。</p>
</li>
</ul>
<hr>
<p><strong>回答</strong>：</p>
<p>　　我呢，6年策划经验，换了5家公司，跟过9个项目，上线5个，大成有2；做过执行，拼过关卡，搭过系统，算过数值，客串过两场主策；踩过潮流的节点，也曾逆流而动；页游入行，转回端游，又跳进手游；待过大公司，见过土老板，窝过小外资，曾在风投热捧的大佬手下干活，还和人鼓捣过创业计划……以上这些吹牛全不重要，关键是，有一天我突然想明白了，所以，现在我已经不做游戏了。（至于原因我会在下面的生涯理想中提到）</p>
<p>　　翻过上面46个回答，没看见有跳出行业的人来现身说法，作为离局者，我提供自己几年的思见作为一个参考视角，这里我对业内的情况不多做细说，只谈一些共通性的问题，希望能有所帮助。</p>
<p>　　我能领会题主所说的那种痛苦与彷徨，因为我也曾这样一路走来。题目中的疑问，我们分开来说，先说工作，再谈生活。</p>
<p>那些年加班伤不起的工作</p>
<p>　　工作，这是人生中完全无法回避的问题，你要花大半辈子时间去熟悉它，理解它，掌握它，运气好可能会爱上它。下面，我们从简单说起，由低到高三个层次：日常工作、职业规划、生涯理想。</p>
<ul>
<li>日常工作</li>
</ul>
<p>　　刚入行的那会，我总是埋头干活，各色需求总是来者不拒，一心想着都是尽快的自我提升，7*12的日子也没少过，直到把生活压榨到极限，才发现想跟上事务的累积速度是永远不可能完成的任务。这时候，我开始学会明确岗位的职责，定位自己的位置，规划工作的事项，降低沟通的成本，改进工作方式，甚至学会适当拒绝。当你从一个混乱无序的状态，到分清轻重缓急之后，工作强度和生活追求之间的对立，也会随之慢慢转为在你个人意志支配之下的共处。</p>
<p>　　前面五点我就不细说，每个人基本都能做到。对于拒绝，大部分人要么过度拒绝，要么不会拒绝。为什么要拒绝。因为有些事务是临时的、不合理的、在你职责之外的、他人转嫁的、扰乱你工作安排、妨害你日常生活的……那么，你有拒绝的权利。这里，拒绝的目的不是为了逃避工作量，而是为了减少被频繁打断插入的次数，从而提高由此造成的效率低下和计划时间的超支。工作中我们要尊重他人的时间，同时也需要让他人学会尊重我们，适当的拒绝可以帮助双方形成一个更加有效的合作方式。这也是常在游戏机制中提到的负反馈的规范作用。<br>拒绝怎样的事情才是适当的。所有在前三点定义之外或与之产生冲突的，且不会对项目造成严重影响的事情，都是可以考虑拒绝掉的。这些可以拒绝掉的事件中，侵占时间最明显的要数：无必要的加班和冗长的会议。陪加班也许是策划最常经历的事件，美其名曰程序和美术遇上问题后好及时沟通，其实这里头包含的问题是你文档结构混乱、讲解说明不清。初始情况思路不周全，没有考虑可执行性细节才有后来的临时沟通需求。如果前期工作做好，逻辑明确，流程图清晰，程序员哥哥们还是很给力的，完全不需要我们随时伺候在侧。会议冗长则基本在于主持者的不作为，没有归纳统合意见，拒绝拍板决断，引导进程不力，导致在某一阶段反复拉锯，大家磨到饭点趁势散会，碰上这种人主持的会议，能逃就逃，逃不掉就提上本本进去办公吧。说这两点，是说可以用完备的前期来拒绝无效的后期；可以用经验来规避低效的风险。</p>
<p>　　为什么要强调拒绝。因为对于业内大多数无知无良的PM和土老板来说，他们对于时间的贪婪永远不会满足，你不学会拒绝，就别提你想要的生活。当然拒绝也要有礼有节有据。不要笼统地说这个不能做，那个没时间。条分理析地说明黑字部分前三点原因，正常的领导会和你寻求解决方案而不是一味刁难。</p>
<p>　　对于奇葩，自然另当别论。我就曾遇到个纱布PM，年终谈绩效的第一句就是：我看你似乎不喜欢加班。心里暗骂一句，嘴上摆开自己的岗位职责、工作事项、负责内容、进度规划、项目的进展、与之的配合。末了，补上一句“我在正常的时间点内正常完成了正常项目规划的正常任务，没有拖慢，没给他人造成困扰，这是我效率的体现。自认100%配得上我的岗位和工资，你有什么意见。如果你对我有其他职责之外的要求，请先拿出相应的诚意，别扯假大空地忽悠我。无效加班这种事除了浪费公司的电力、能蹭个免费工作餐外，唯一的价值就是让老大偶尔路过时，觉得你手下工作上心你有面子，反正这种群众演员不差我一个。”那位在我目前生涯中奇葩度暂居榜首的PM唯喏半晌说不出话来，几个月后，我便跳槽高就去了。说这个，是为了说明日常工作的最后一点：遇见傻逼的时候，甭客气，别陷在里头陪他玩儿。</p>
<ul>
<li>职业规划</li>
</ul>
<p>　　一般说到职业规划时，我们谈的总是在当前岗位上的上行通道。这条路，大家都很明晰了，不需赘言。稍微提上两句的就是：当你想往上升的时候，不要只看到职位以及所能带来的权益。而应该尝试使用目标职位的思路，来考虑对待你当下所从事的工作，以及对全局走势的一个看法。多想一些再与实际相印证总不会有坏处。很多事情其实是想的时候指点江山容易，真轮到你干也许更加坑爹。比如在看到全线飘红红的加班安排时，你有没有看到项目层的压力，以及公司态度的微妙转变，当你觉得通过某个改动很傻逼的时候，有没有算过其中的风险系数。当然你觉得某项决定真心傻逼时，你有没有考虑过可能会造成的影响，以及是不是该预备两手补救措施。如果只着眼手上的事务，那么成长将变得缓慢。</p>
<p>　　接下来，我们尝试把视野更开阔一些，不要只关注直接对应的上升通道，可以关注与其他行业交叉结合处的工作可能，可以考虑跨行业优势所在和短板补足，或者当你的业余爱好远强于工作储备时，是不是考虑换个更擅长的更有意思的来做。这世界上有很多更好玩的事情，不要被手上的工作局限了双眼。这些说起来都很简单，但实践起来相当困难。当你在一个行业内累积相当经验后，想要换个方向面对未知的环境和不可预知的风险时，对谁都是一个艰难的决定。我身边离开游戏圈的朋友大部分选择回老家当安稳的公务员，也有一些跳去做产品经理的。而我呢，一度想去做TMT分析，现在暂时是跑去做电商，不过两年后肯定又会是另一个职业。对于未来，我有一个算是明确但不明晰的想法，走着走着也许就走通了。</p>
<p>　　到这里，我想返回头说下有关规划的个人观点：我认为规划实际上是一个在学习中进步，让能力匹配上目标的过程。规划的重点在于建立、明确、完善一套属于自己的方法论和世界观，而非仅是简单职业的成长。当你手中不仅是握着实操的具体经验，而是一套行之有效的处理问题的方式方法与学习能力之后，我想，就算跳到一个十万八千里外的行业中，也能很快成长起来。我一直相信一句话：凡所经历，皆是加持。这里加持的并非具体的事件，而是通过事件总结出的经验教训。以此为基础产生的认识，对未来的期许，才算得上是规划。</p>
<ul>
<li>生涯理想</li>
</ul>
<p>　　每个人入行时，都对着工作抱有着憧憬。这些理想是入行的动力，也是维系工作的热情。就算最不受待见的公务员，也是希望能过上朝九晚五喝茶看报的舒坦日子。但理想和现实总存在着出入，有时候差异可能很大。这种落差从工作内容到工作目标上都无时无刻地在消蚀你的热情。这时候，就需要重塑和纠正最初的理想。</p>
<p>　　我不敢说每个入行的游戏从业者都是抱着对游戏一腔热血而入行的，比如我就见过啥也不懂游戏都不玩，光听说游戏业赚钱就想进来当策划混口饭吃的90后；也见过许多美术和程序漠不关心项目，只看分配到自己工作。但是我还一直抱有一个理想，希望有朝一日能带出一款自己满意、开发团队喜欢、玩家热爱的产品；如果还有可能，我希望通过游戏传递快乐的同时，能带给玩家一个相对客观、正向的价值导向；我的野望，或者说狂妄也就到此为止了。</p>
<p>　　但是现在，我却已不再做游戏了。我一直认为，策划的本质就是将快乐的方法通过游戏传递出去。而现在，我看到的和做过的大多游戏传递而出的却是一种赤裸裸的逐利意识。我不反对赚钱，我只是本能反感这种简单粗暴毫无美感的圈钱方式。刚开始的时候，我曾因为宝箱的机制和人吵过，为耐久的扣点和人吵过，为加星的爆率和人吵过，为了各自匪夷所思的收费陷阱和人理论……随着后来的整个游戏圈的约定俗成，我逐步妥协，却还是觉得应该坚持一个不作恶的底线。当我看到，越来越多的所谓玩点其实就是收钱的坑点的时候，玩游戏的玩家越花钱越不开心，我感到我的工作也越来越不开心。当我的开心依附于玩家砸入用于购买开心的钱化入公司的户头再转为个人工资的时候，我感到这份工作已经失却了最初的理想。</p>
<p>　　曾待过一个公司，会让策划定期去听客服录音，有天晚上便听到一个小姑娘质问：为什么我花了六千块钱还洗不出一个完美的宠物宝宝！关于这个问题的内部回答是什么呢？呵，理论上这是两万块钱才会出现的概率哦。嗯，两万软妹币换得200%的成长模板和两个紫红耀眼的大字。是的，这钱不偷、不抢、不蒙、不骗、不犯法，但是对于三观懵懂的小盆友来说，你导出这样的价值取向给他真的大丈夫吗？而那些我被人砍了要花多少钱买什么才能报仇这样的客服问答我就不提了。关于这些，我不喜欢，真的不喜欢。</p>
<p>　　于是，我又重新思考了下自己的职业理想，赚大钱并不在我的首位，我更想做的是些好玩有趣，为人们提供欢乐，便利人们生活，不作恶、正能量的互联网科技项目。最后，我就离开了。</p>
<p>　　当在离职原因一栏写下：“不爱了”三个字与游戏圈作别时，心底其实涌过一阵轻松：我终于敢放下这个我且算精通，将要出头，却早已麻木的工作。《Fight Club》里说“It’s only after we’ve lost everyting that we’re free to do anyting.”我觉得我正逼近这个状态。</p>
<p>　　总之呢，道不同不相为谋。如果不放弃眼下，便无法收获未来。如果你不去尝试，永远不知道自己适合什么。窄门未必能上天堂，但自己走得舒坦就成。当你对工作感到彷徨、失意和痛苦的时候，就想想最初的理想，可忍耐的忍耐，该离开时离开。这些都是我的个人观点，也许我生来就是一个不安分的人，觉得折腾也并非是坏事。</p>
<p>谁不想有个明媚的生活</p>
<p>　　扯完工作，来说生活。很多时候，我们抱怨工作繁重，仅剩生存。但真给你一个假期，你除了用来睡觉、吃饭、发呆之外，可曾用来真正的活一下？我见过不少策划，下班之后宁愿领份加班盒饭，坐在电脑前上网、聊天、打游戏也不愿下班。就算这样，他们也会抱怨自己没有生活。你口中的生活仅仅是一段可有可无仅供浪费的空闲时间，还是一段用于支撑兴趣爱好的必备时间？如果是前者，因为没有规划没有权重自然随时能被压榨；如果是后者，你有所坚持自然能有保留。所以怎么能说得那么绝对，没有生活呢。时间，挤挤总会有的。上班的时间真是百分百就在干活吗？就算工作时长真的无法缩短的情况下，你难道不能将生活反向渗透到工作中吗，时间再紧，也压缩不到拉屎吧（曾经一上厕所就开始背单词这种事情我会拿出来乱说吗）。总之，以我的观点，你真心需要一段时间的时候，无论如何你都会为它留出位置。如果仅限于口头抱怨，那么就做好继续抱怨到老的觉悟。所谓生活质量，不是有时间就有质量，首先你得有想法、有行动才有质量。</p>
<p>　　关于特别提出的女朋友。我想先问一句：你是真想找个携手到老的伴侣呢，还是仅仅想享受女朋友所带来的好处。我认识的单身死宅们，大都停留在后一个的幻想阶段。在一地狼藉的屋子里光着膀子打着dota，一边喊着为什么我没有女盆友这种人活该孤单到老。没想法、没追求、没行动，总幻想有一天有个白来的妹子，呵呵呵呵，祝你成功。对于真心想找妹子的小伙伴呢，就送9个字啦：“高筑墙、广积粮、缓称王”。翻译过来就是：自我提升、扩大圈子、别急着确立关系（这里说的不是屯备胎和玩暧昧，是说对待感情要慎重啦，不能仅仅是因为寂寞就在一起，因为长得好就在一起，因为有车有房就在一起……不然，出来混迟早要还的。）至于哪里找，怎么追，如何相处都是后话。首先你得摆正态度。大家都是做项目的，自然知道执行才是关键，守株待兔、怨天尤人是从来没有结果的。别说前面没路，当你想走时，自然就有路了。</p>
<p>　　我一再强调行动与态度，否定主观的归因，大抵是因为我本身是一个偏执的行动派吧。从来觉得与其花时间来抱怨不如着手改善，所有事情认真去做总有解决方案，代价大小的问题。（为了证明这一大段不是信口开河空口大话，我随便自曝一下，EX就是我在7*12的工作强度下遇上的，是一个和我工作与日常交际中完全不搭边的圈子，细节也不说了，每人都有自己擅长的方法，总之，俩人很开心，一块处了三年。虽然最后分开了，现在想来还是惘然。）</p>
<p>via:知乎</p>
<p>这片文章很喜欢,作者的价值观跟我非常像,昨天看86届奥斯卡的颁奖礼,《12 Years a Slave》的男主切瓦特·埃加福特(Chiwetel Ejiofor)在片中有这样一句台词:<strong>“I don’t want to survive. I want to live”</strong></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-12T17:18:53.000Z"><a href="/2014/03/13/about-gdb/">2014-03-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/13/about-gdb/">关于 gdb 的一些命令使用</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Linux下gdb的使用和命令">Linux下gdb的使用和命令</h2><p>  一般来说，GDB主要帮忙你完成下面四个方面的功能： </p>
<p>1、启动你的程序，可以按照你的自定义的要求随心所欲的运行程序。</p>
<p>2、可让被调试的程序在你所指定的调置的断点处停住。（断点可以是条件表达式） </p>
<p>3、当程序被停住时，可以检查此时你的程序中所发生的事。 </p>
<p>4、动态的改变你程序的执行环境。 </p>
<p>(命令行的调试工具却有着图形化工具所不能完成的功能)</p>
<hr>
<p>下面介绍gdb常用的命令</p>
<h3 id="1-_显示源代码,必须在编译的时候使用_-g_参数才可以">1. 显示源代码,必须在编译的时候使用 <em>-g</em> 参数才可以</h3><h4 id="list:">list:</h4><p><code>(gdb) list</code><br>显示当前运行位置的前5行和后5行代码  </p>
<p><code>(gdb) list function</code><br><code>(gdb) list filename:function</code><br>显示所指向的本文件的函数或者其他文件内函数的前2行和后8行代码  </p>
<p><code>(gdb) list -</code><br>往前显示代码  </p>
<p><code>(gdb) list +</code><br>往后显示代码  </p>
<p>这些命令默认都是显示10行,可以用<code>set listsize 20</code> 修改显示的行数为20行,用<code>show listsize</code>查看当前设置的显示数量.</p>
<p>list命令还有下面的用法： </p>
<p><code>(gdb) list &lt;first&gt;, &lt;last&gt;</code><br>显示从first行到last行之间的源代码。  </p>
<p><code>(gdb) list , &lt;last&gt;</code><br>显示从当前行到last行之间的源代码。 </p>
<h3 id="2-_查看运行时数据">2. 查看运行时数据</h3><h4 id="print:">print:</h4><p> 在你调试程序时，当程序被停住时，你可以使用<code>print</code>命令（简写命令为<code>p</code>)<code>print</code>命令的格式是：<br> <code>(gdb) print n</code>  </p>
<p>打印出变量n的值,可以按照指定的进制查看变量的值,比如 <code>int n=5</code> 可以使用 <code>print/x n</code> 命令得到 <code>$26 = 000000101</code>结果<br> <code>(gdb) whatis p</code><br> <code>type = int*</code><br> 显示某个变量的类型</p>
<p>  <code>(gdb) print Findfuc(1,0)</code><br>  对程序中函数的调用 </p>
<p>  <code>(gdb) print *pCTable</code><br>  <code>$8={e=reference=’/000’,location=0x0,next=0x0}</code><br>  数据结构和其他复杂对象  </p>
<p>  <code>(gdb)print h@10</code><br>  <code>$13=(-1,345,23,-234,0,0,0,98,345,10)</code><br>  查看内存中在变量h后面的10个整数，一个动态数组的语法如下所示:base@length  </p>
<h4 id="display:">display:</h4><p>   还没怎么接触过,留空.</p>
<h4 id="backtrace:">backtrace:</h4><p>   打印当前的函数调用栈的所有信息。如：<br><code>(gdb) bt</code><br><code>#0 func (n=250) at tst.c:6</code><br><code>#1 0x08048524 in main (argc=1, argv=0xbffff674) at tst.c:30</code><br><code>#2 0x400409ed in __libc_start_main () from /lib/libc.so.6</code><br>从上可以看出函数的调用栈信息：<code>__libc_start_main --&gt; main() --&gt; func()</code> </p>
<h4 id="frame_up_down:">frame up down:</h4><p>  切换栈<br>  <code>(gdb) frame 1</code><br>  切换到<code>bt</code>显示出来的栈序号为1的栈中去.<br>  比如：<code>frame 0</code>，表示栈顶,上面的例子中就是func所在栈,一般当前程序执行的位置的栈就是栈顶，<code>frame 1</code>，表示栈的第二层,<br>  即 <code>main</code>函数所在栈  </p>
<p> <code>(gdb) up n</code><br>  表示向栈的上面移动n层，可以不打n，表示向上移动一层。  </p>
<p> <code>(gdb) down n</code><br>  表示向栈的下面移动n层，可以不打n，表示向下移动一层。  </p>
<h3 id="3-_断点">3. 断点</h3><h4 id="break:">break:</h4><p>   <code>break</code>命令（可以简写为<code>b</code>）可以用来在调试的程序中设置断点.<br>   <code>(gdb) break filename:line-number</code><br>   在指定文件的指定行上设置一个断点  </p>
<p>   <code>(gdb) break filename:function-name</code><br>   在指定文件的指定函数入口处设置一个断点  </p>
<p>   <code>(gdb) break line-or-function if expr</code><br>   在指定行号或者指定函数内设置一个断点,当expr条件成立时断住程序,如:<code>break 46 if dwCount==100</code>  </p>
<p>   <code>(gdb) info break</code><br>   <code>Num Type Disp Enb Address What</code><br>   <code>1 breakpoint keep y 0x000028bc in CApp:Init at CApp.cpp:155</code><br>   <code>2 breakpoint keep y 0x0000291c in main at GameApp.cpp:168</code><br>   显示断点信息  </p>
<p>   <code>(gdb) delete breakpoint 1</code><br>   删除编号为1的断点   </p>
<p>   <code>(gdb) delete breakpoint</code><br>   删除所有断点  </p>
<h4 id="watch_:">watch :</h4><p>设置观察点,还没怎么用过,留空</p>
<h4 id="catch_:">catch :</h4><p>设置捕捉点,还没怎么用过,留空</p>
<h3 id="4-_执行">4. 执行</h3><h4 id="run_continue_next_step_finish_until:">run continue next step finish until:</h4><p>程序执行  </p>
<p><code>(gdb) set args</code><br>可指定运行时参数。（如：<code>set args 10 20 30 40 50</code>） </p>
<p><code>(gdb) show args</code><br>查看设置好的运行参数</p>
<p><code>(gdb) run</code><br>执行程序</p>
<p><code>(gdb) continue</code><br>执行到下一个断点 相当于vs里的F5快捷键</p>
<p><code>(gdb) next</code><br>执行下一句代码 相当于vs里的F10快捷键</p>
<p><code>(gdb) step</code><br>执行下一句代码,如果下一句代码调用了函数,那么进入该函数,相当于vs里的F11快捷键</p>
<p><code>(gdb) finish</code><br>跳出当前函数,相当于vs里的shift+F11快捷键</p>
<p><code>(gdb) until</code><br>跳出当前while或者for循环(这个貌似在vs里是没有的,求大牛指点)</p>
<h4 id="jump:">jump:</h4><p>跳转执行,还没怎么用过,留空</p>
<h4 id="call:">call:</h4><p>强制调用函数,留空</p>
<h3 id="5-_其他">5. 其他</h3><p>还有一些关于”信号”,”搜索”等没怎么接触过的命令和用法,有待以后工作和学习中接触到之后再填补.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-08T13:37:28.000Z"><a href="/2014/03/08/constandstatic/">2014-03-08</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/08/constandstatic/">const和static的用法</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="const和static的用法总结">const和static的用法总结</h2><h3 id="const的用法">const的用法</h3><h4 id="1-_const修饰变量和指针">1. const修饰变量和指针</h4><pre><code><span class="keyword">const</span>修饰变量和指针即表示该变量和指针不能被修改,一般在遇到<span class="keyword">const</span> <span class="keyword">char</span>* 的时候会
产生歧义.<span class="keyword">const</span> <span class="keyword">char</span>* 这种结构的定义其实只要找到<span class="keyword">const</span>修饰的是哪种变量类型就可以
知道究竟哪个量是不可修改的了.比如, <span class="keyword">const</span> (<span class="keyword">char</span>*) pBuffer <span class="keyword">const</span>修饰的是 <span class="keyword">char</span>*
类型 ,所以pBuffer作为一个<span class="keyword">char</span>*类型的变量被<span class="keyword">const</span>,pBuffer的值也就是这个指针的值是
不能被修改的.而 <span class="keyword">const</span> (<span class="keyword">char</span>) *pBuffer <span class="keyword">const</span>修饰的是<span class="keyword">char</span>类型,所以*pBuffer的<span class="keyword">char</span>
内容是不能被修改的.所以以后要是有人给你出这种题目,抓住<span class="keyword">const</span>修饰的类型就好了.
</code></pre><h4 id="2-_const修饰函数参数">2. const修饰函数参数</h4><pre><code>这种情况主要是为了保护实参在函数内不被改变,比如 <span class="keyword">void</span> <span class="built_in">function</span>(<span class="keyword">const</span> <span class="built_in">char</span> *p),p所
指向的内容是不能在函数中被修改的,否则编译不通过.还有 <span class="keyword">int</span> <span class="built_in">function</span>(<span class="keyword">const</span> A &amp;a)这种
用法,避免拷贝构造函数的调用和析构函数的调用,采用传引用的方法,加<span class="keyword">const</span>修饰可以避免
函数内部对a对象的修改.
</code></pre><h4 id="3-_用const修饰函数的返回值">3. 用const修饰函数的返回值</h4><pre><code>如果给以“指针传递”方式的函数返回值加const修饰，那么函数返回值（即指针）的内
容不能被修改，该返回值只能被赋给加const修饰的同类型指针。
例如函数:
<span class="comment"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">GetString</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></span>

如下语句将出现编译错误：
<span class="comment"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *str = GetString();</span><br></pre></td></tr></table></figure></span>

正确的用法是
<span class="comment"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *str = GetString();</span><br></pre></td></tr></table></figure></span>
</code></pre><h4 id="4-_const成员函数">4. const成员函数</h4><pre><code>任何不改变成员变量值的成员函数都应该被定义为const成员函数,const放在函数声明后面

<span class="comment"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CStack</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetCount</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> m_dwNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CStack::GetCount() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">	m_dwNum++; <span class="comment">//编译错误,不能对成员变量进行修改;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></span>
</code></pre><p> 总之,const的作用就是定义只读,在一定程度上控制程序员的失误操作,保证程序的健壮和稳定.</p>
<hr>
<h3 id="static的用法">static的用法</h3><ol>
<li><p>隐藏</p>
<p> 在两个源文件中,如果定义了全局的变量和函数,两个源文件中都可以使用这些全局变量和函数,<br> 如果想让变量和函数只在当前文件中起作用,就要加<code>static</code>前缀将函数隐藏在本源文件中.</p>
</li>
</ol>
<ol>
<li><p>类的静态成员</p>
<p> 类的静态成员只属于类本身,不属于任何一个类实例,所以没有this指针.如:</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CStack</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> m_dwCount;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetCount</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> CStack::m_dwCount = <span class="number">10</span>;</span><br><span class="line">CStack::GetCount()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> m_dwCount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//静态成员函数不能访问类的私有成员，只能访问类的静态成员,</span></span><br><span class="line"><span class="comment">//实际上，它就是增加了类的访问权限的全局函数</span></span><br></pre></td></tr></table></figure>
<p> 静态成员必须要在定义中初始化.</p>
</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/C/">C++</a><small>16</small></li>
  
    <li><a href="/tags/DB/">DB</a><small>2</small></li>
  
    <li><a href="/tags/FTP/">FTP</a><small>1</small></li>
  
    <li><a href="/tags/HTTP/">HTTP</a><small>1</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>12</small></li>
  
    <li><a href="/tags/Redis/">Redis</a><small>3</small></li>
  
    <li><a href="/tags/博客/">博客</a><small>23</small></li>
  
    <li><a href="/tags/技术/">技术</a><small>22</small></li>
  
    <li><a href="/tags/源代码/">源代码</a><small>1</small></li>
  
    <li><a href="/tags/转载/">转载</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 16.67px;">C++</a> <a href="/tags/DB/" style="font-size: 11.67px;">DB</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Redis/" style="font-size: 13.33px;">Redis</a> <a href="/tags/博客/" style="font-size: 20px;">博客</a> <a href="/tags/技术/" style="font-size: 18.33px;">技术</a> <a href="/tags/源代码/" style="font-size: 10px;">源代码</a> <a href="/tags/转载/" style="font-size: 10px;">转载</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://www.google.com/" title="google">google</a></li>
</ul>
</div>

  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1235899094&verifier=a6902c2e&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2018 shafeng
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>